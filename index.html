<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>Dead by Daylighté…åˆ†å°éŠæˆ²</title>
  <style>
    :root {
      --bg: #05060a;
      --bg2: #101321;
      --bg3: #15192a;
      --card: #181d2e;
      --border: #2a3044;
      --accent: #3f82ff;
      --accent-soft: #7aa7ff;
      --accent-danger: #ff4b5c;
      --text: #f5f5f5;
      --muted: #a6a9c0;
      --chip-bg: rgba(255, 255, 255, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #262c45 0%, #050609 55%);
      color: var(--text);
    }

    .app {
      max-width: 1240px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 span.small {
      font-size: 14px;
      color: var(--muted);
      font-weight: 400;
    }

    .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-top: 16px;
    }

    .mode-tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.08);
      gap: 4px;
    }

    .mode-tab {
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .mode-tab.active {
      background: linear-gradient(120deg, var(--accent), var(--accent-soft));
      color: #fff;
      font-weight: 600;
    }

    .layout {
      margin-top: 18px;
    }

    .card {
      border-radius: 14px;
      background: linear-gradient(145deg, rgba(12, 15, 25, 0.98), rgba(20, 25, 38, 0.98));
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 18px 38px rgba(0, 0, 0, 0.7);
      padding: 14px;
    }

    .card+.card {
      margin-top: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 3px;
    }

    select,
    input[type="text"],
    button {
      background: #141726;
      border: 1px solid #2a3044;
      border-radius: 6px;
      color: var(--text);
      padding: 7px 9px;
      font-size: 13px;
      outline: none;
    }

    select:focus,
    input[type="text"]:focus,
    button:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(63, 130, 255, 0.5);
    }

    button {
      cursor: pointer;
    }

    button.primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-soft));
      border: none;
      color: #fff;
      font-weight: 600;
    }

    button.primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button.outline {
      background: transparent;
      border-color: rgba(255, 255, 255, 0.16);
      color: var(--muted);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .flex-1 {
      flex: 1;
      min-width: 180px;
    }

    .flex-2 {
      flex: 2;
      min-width: 260px;
    }

    .mt-8 {
      margin-top: 8px;
    }

    /* === é…åˆ†æ¨¡å¼ layout === */

    .points-layout {
      display: grid;
      grid-template-columns: 2.1fr 1.4fr;
      gap: 16px;
    }

    @media (max-width: 1040px) {
      .points-layout {
        grid-template-columns: 1fr;
      }
    }

    .list-container {
      max-height: 320px;
      overflow: auto;
      padding-right: 6px;
      margin-top: 6px;
    }

    .addon-item,
    .perk-item {
      display: grid;
      grid-template-columns: 48px 1fr auto;
      gap: 10px;
      padding: 8px 8px;
      margin-bottom: 6px;
      border-radius: 10px;
      background: rgba(11, 13, 23, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.04);
      cursor: pointer;
      transition: background 0.14s ease, border-color 0.14s ease, transform 0.06s;
    }

    .addon-item:hover,
    .perk-item:hover {
      background: rgba(21, 24, 36, 0.98);
      border-color: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    .addon-item.selected,
    .perk-item.selected {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(63, 130, 255, 0.5);
      background: radial-gradient(circle at top left, rgba(63, 130, 255, 0.25), rgba(11, 13, 23, 0.98));
    }

    .thumb {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      background: #101320;
      border: 1px solid var(--border);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--muted);
      flex-shrink: 0;
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .list-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .list-name {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .list-zh {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tags-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .tag {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 11px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: var(--muted);
    }

    .tag-score {
      border-color: rgba(255, 255, 255, 0.4);
      color: #ffe08a;
    }

    .list-right {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: space-between;
      gap: 4px;
    }

    .badge {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.35);
      font-size: 11px;
    }

    .selected-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid rgba(255, 255, 255, 0.14);
      font-size: 12px;
    }

    .selected-pill img {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      object-fit: contain;
    }

    .pill-remove {
      cursor: pointer;
      font-size: 14px;
      opacity: 0.7;
    }

    .pill-remove:hover {
      opacity: 1;
    }

    .selected-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .selected-pill {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      background: #101320;
      border: 1px solid rgba(255, 255, 255, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    .selected-pill img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }

    .pill-remove {
      position: absolute;
      top: 4px;
      right: 6px;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.8;
      color: #fff;
      text-shadow: 0 0 4px #000;
    }

    .pill-remove:hover {
      opacity: 1;
    }

    .section-note {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* === å³å´ Killer + æŠ€èƒ½åœ–ç¤º === */

    .killer-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
    }

    .build-main-layout {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      margin-top: 8px;
    }

    .kill-avatar-wrap {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .killer-avatar {
      width: 250px;
      height: 250px;
      border-radius: 12px;
      overflow: hidden;
      background: #111422;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 13px;
      flex-shrink: 0;
    }

    .killer-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .killer-name-main {
      font-size: 15px;
      font-weight: 600;
    }

    .killer-name-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .skills-row {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .skill-slot {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      background: #101320;
      border: 1px dashed rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    .skill-slot.filled {
      border-style: solid;
      border-color: rgba(255, 255, 255, 0.35);
      background: radial-gradient(circle at top, rgba(63, 130, 255, 0.35), #05060a);
    }

    .skill-slot img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      cursor: pointer;
    }

    .skill-slot span.placeholder {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      padding: 2px;
    }

    .skill-label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .build-summary {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .build-summary strong {
      color: #fff;
    }

    /* === æ‹‰éœ¸æ¨¡å¼ === */

    .slot-section {
      margin-top: 24px;
      display: flex;
      justify-content: center;
    }

    .slot-machine {
      width: 1150px;
      max-width: 100%;
      padding: 30px;
      border-radius: 26px;
      background: linear-gradient(145deg, #b49a62, #7d683e);
      border: 8px solid #5e4a28;
      box-shadow:
        inset 0 0 20px rgba(0, 0, 0, 0.6),
        0 0 18px rgba(255, 222, 150, 0.2),
        0 0 32px rgba(0, 0, 0, 0.8);
      position: relative;
    }

    .slot-machine::before {
      content: "";
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(120deg,
          rgba(255, 255, 255, 0.02) 0px,
          rgba(255, 255, 255, 0.02) 2px,
          rgba(0, 0, 0, 0.12) 5px);
      pointer-events: none;
    }

    .slot-machine.glow {
      box-shadow:
        inset 0 0 20px rgba(0, 0, 0, 0.6),
        0 0 30px rgba(255, 240, 200, 0.7),
        0 0 60px rgba(255, 240, 200, 0.95);
      animation: slotMachineGlow 1.3s ease-in-out infinite alternate;
    }

    @keyframes slotMachineGlow {
      0% {
        transform: scale(1);
        filter: brightness(1);
      }

      100% {
        transform: scale(1.01);
        filter: brightness(1.08);
      }
    }

    #cardContainer {
      width: 100%;
      max-width: 1150px;
      margin: 8px auto 0;
      display: flex;
      justify-content: center;
      gap: 12px;
      opacity: 0;
      transform: translateY(16px);
      pointer-events: none;
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
    }

    #cardContainer.card-visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .slot-header {
      margin-bottom: 10px;
    }

    .slot-title-main {
      font-size: 18px;
      font-weight: 600;
    }

    .slot-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .slot-inner {
      margin-top: 8px;
      background: #1a1a1a;
      border-radius: 16px;
      border: 5px solid #8f6e3c;
      padding: 24px 18px 28px;
      box-shadow:
        inset 0 0 15px rgba(0, 0, 0, 0.7),
        0 0 10px rgba(255, 210, 140, 0.25);
      display: flex;
      justify-content: center;
      position: relative;
    }

    .slot-board-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .slot-board {
      display: grid;
      grid-template-columns: repeat(7, 120px);
      gap: 12px;
      justify-content: center;
    }

    .slot-cell {
      width: 120px;
      min-height: 160px;
      border-radius: 14px;
      background: #101320;
      border: 1px solid var(--border);
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
      box-shadow:
        inset 0 0 12px rgba(0, 0, 0, 0.7),
        0 0 8px rgba(0, 0, 0, 0.8);
    }


    .slot-anim-out {
      animation: slotFadeOutUp 0.3s ease forwards;
    }

    .slot-anim-in {
      animation: slotFadeInUp 0.3s ease forwards;
    }

    @keyframes slotFadeOutUp {
      0% {
        opacity: 1;
        transform: translateY(0);
      }

      100% {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    @keyframes slotFadeInUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slot-cell-label {
      font-size: 11px;
      color: var(--muted);
    }

    .slot-icon {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      background: #05060a;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--muted);
      padding: 4px;
    }

    .slot-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .slot-name {
      font-size: 11px;
      text-align: center;
      color: #ddd;
      padding: 0 2px;
    }

    .lever-normal,
    .lever-bottom {
      position: absolute;
      right: -80px;
      top: 50%;
      transform: translateY(-50%);
      width: 120px;
      height: 260px;
      display: flex;
      justify-content: center;
      align-items: flex-end;
    }

    .lever-bottom {
      display: none;
    }

    .lever-stick {
      width: 22px;
      height: 150px;
      background: linear-gradient(180deg, #a98a4a, #6e5a33);
      border-radius: 12px;
      position: relative;
      box-shadow:
        inset 0 0 10px rgba(0, 0, 0, 0.6),
        0 10px 14px rgba(0, 0, 0, 0.6);
    }

    .lever-ball,
    .bottom-ball {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ff5a5a, #7a0000);
      box-shadow:
        inset 0 0 16px rgba(255, 255, 255, 0.3),
        0 0 14px rgba(0, 0, 0, 0.8);
    }

    .lever-ball {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
    }

    .bottom-ball {
      margin-bottom: 5px;
    }

    .slot-hint {
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .slot-board.win-anim {
      animation: slotGlow 0.8s ease-in-out 3;
    }

    @keyframes slotGlow {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
        transform: scale(1);
      }

      50% {
        box-shadow: 0 0 32px 4px rgba(255, 215, 128, 0.7);
        transform: scale(1.01);
      }
    }

    .slot-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      font-size: 18px;
      color: #ffe8a0;
      text-shadow: 0 0 12px rgba(0, 0, 0, 0.8);
    }

    .hidden {
      display: none !important;
    }

    /* --- å³ä¸Šè§’å•è™ŸæŒ‰éˆ• --- */
    #help-btn {
      position: fixed;
      top: 22px;
      right: 28px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 1.8px solid rgba(255, 255, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: #fff;
      cursor: pointer;
      backdrop-filter: blur(6px);
      background: rgba(0, 0, 0, 0.35);
      z-index: 9999;
      transition: 0.15s ease;
    }

    #help-btn:hover {
      transform: scale(1.08);
      border-color: #3f82ff;
    }

    /* --- Modal èƒŒæ™¯ --- */
    #help-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }

    /* --- Modal å…§å®¹æ¡† --- */
    .help-content {
      width: 420px;
      max-height: 78vh;
      background: #121622;
      border-radius: 14px;
      border: 1px solid #2a3044;
      padding: 18px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
      overflow-y: auto;
    }

    /* --- Header --- */
    .help-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 18px;
      font-weight: 600;
    }

    #help-close {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
    }

    /* --- èªªæ˜æ–‡æœ¬ --- */
    .help-text {
      font-size: 14px;
      line-height: 1.6em;
      color: #d3d6e4;
      white-space: pre-line;
    }

    /* === Dice (Scoring mode only) === */
    /* === Dice (Fake 3D cube) === */
    #diceFlying {
      position: fixed;
      width: 64px;
      height: 64px;
      left: -80px;
      top: -80px;
      transform: translate(0, 0);
      transition: transform .9s cubic-bezier(.2, .8, .2, 1);
      z-index: 9999;
      pointer-events: none;
      display: none;
      perspective: 1100px;
      perspective-origin: 50% 50%;
    }

    #diceFlying .dice-cube {
      width: 64px;
      height: 64px;
      position: relative;
      transform-style: preserve-3d;
      /* âœ… è®“ç«‹æ–¹é«”ä»¥ä¸­å¿ƒç‚ºæ—‹è½‰ä¸­å¿ƒï¼ˆå¾ˆé—œéµï¼‰ */
      transform: translateZ(-32px);
      transition: transform .9s cubic-bezier(.2, .8, .2, 1);
      will-change: transform;
    }

    #diceFlying .face-front {
      background-image: url("./images/other/éª°å­1.png");
    }

    #diceFlying .face-back {
      background-image: url("./images/other/éª°å­6.png");
    }

    #diceFlying .face-right {
      background-image: url("./images/other/éª°å­3.png");
    }

    #diceFlying .face-left {
      background-image: url("./images/other/éª°å­4.png");
    }

    #diceFlying .face-top {
      background-image: url("./images/other/éª°å­2.png");
    }

    #diceFlying .face-bottom {
      background-image: url("./images/other/éª°å­5.png");
    }

    #diceFlying .dice-face {
      position: absolute;
      width: 64px;
      height: 64px;
      backface-visibility: hidden;
      background-size: cover;
      background-position: center;
      border-radius: 10px;
      /* âœ… é‚Šç·£/é™°å½±ï¼Œè®“å®ƒã€Œä¸æ˜¯ä¸€å¼µå¹³é¢åœ–ã€ */
      outline: 1px solid rgba(255, 255, 255, 0.10);
      box-shadow:
        inset 0 0 0 1px rgba(255, 255, 255, 0.06),
        0 10px 22px rgba(0, 0, 0, 0.35);
    }

    /* Place faces (cube half-size = 32px) */
    #diceFlying .face-front {
      transform: rotateY(0deg) translateZ(32px);
      filter: brightness(1.05);
    }

    #diceFlying .face-back {
      transform: rotateY(180deg) translateZ(32px);
      filter: brightness(0.85);
    }

    #diceFlying .face-right {
      transform: rotateY(90deg) translateZ(32px);
      filter: brightness(0.95);
    }

    #diceFlying .face-left {
      transform: rotateY(-90deg) translateZ(32px);
      filter: brightness(0.90);
    }

    #diceFlying .face-top {
      transform: rotateX(90deg) translateZ(32px);
      filter: brightness(1.10);
    }

    #diceFlying .face-bottom {
      transform: rotateX(-90deg) translateZ(32px);
      filter: brightness(0.80);
    }

    #diceModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .55);
      z-index: 10000;
    }

    #diceModal .box {
      background: #111827;
      color: #e5e7eb;
      padding: 18px 22px;
      border-radius: 12px;
      min-width: 260px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .6);
    }

    #diceModal button {
      margin-top: 12px;
      padding: 8px 14px;
      border-radius: 8px;
      border: 0;
      background: #3f82ff;
      color: #fff;
      cursor: pointer;
    }



    /* Dice (left/right) */
    #diceRightBtn.dice-number {
      background: #2a3044;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: 0.8px;
      font-variant-numeric: tabular-nums;
      width: 56px;
      height: 56px;

      /* âœ… ç½®ä¸­ä¿®æ­£ï¼ˆé¿å…å…¨åŸŸ button padding è®“æ–‡å­—æ­ªï¼‰ */
      padding: 0 !important;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .dice-icon {
      width: 36px;
      height: 36px;
      object-fit: contain;
      pointer-events: none;
    }

    /* âœ… Dice buttons: çµ±ä¸€ç½®ä¸­ï¼ˆé¿å…å…¨åŸŸ button padding å½±éŸ¿ï¼‰ */
    #diceLeftBtn,
    #diceRightBtn {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      outline: none !important;

      padding: 0 !important;
      width: 56px;
      height: 56px;

      display: flex;
      align-items: center;
      justify-content: center;
    }

    #diceLeftBtn:focus,
    #diceRightBtn:focus,
    #diceLeftBtn:active,
    #diceRightBtn:active {
      outline: none !important;
      box-shadow: none !important;
    }

    /* âœ… æ•¸å­—ç‹€æ…‹ï¼šé¡¯ç¤ºåƒç¥ç±¤ä¸€æ¨£çš„æ¡†æ¡†ï¼ˆè¦†è“‹ä¸Šé¢ transparent è¦å‰‡ï¼‰ */
    #diceRightBtn.dice-number {
      background: #2a3044 !important;
      border: 1px solid rgba(255, 255, 255, 0.35) !important;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.45), inset 0 0 0 1px rgba(255, 255, 255, 0.08) !important;
      border-radius: 12px !important;
      color: #fff !important;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: 0.8px;
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }


    /* âœ… éª°å­åœ–ç¤ºç‹€æ…‹ï¼šåƒç±¤ç­’ä¸€æ¨£æ²’æœ‰æ¡†æ¡†ï¼ˆä¿ç•™æ•¸å­—ç‹€æ…‹çš„æ¡†ï¼‰ */
    #diceLeftBtn:not(.dice-number),
    #diceRightBtn:not(.dice-number) {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      outline: none !important;
    }

    /* === Dice rolling animation (separate from translate) === */
    @keyframes diceRollSpin {
      0% {
        transform: translateZ(-32px) rotateX(0deg) rotateY(0deg) rotateZ(0deg);
      }

      100% {
        transform: translateZ(-32px) rotateX(1080deg) rotateY(1440deg) rotateZ(720deg);
      }
    }

    #diceFlying.rolling .dice-cube {
      /* animation replaced by JS controller for smooth damping stop */
      animation: none;
    }

    /* === Slot Settings (Slot mode only) === */
    .slot-settings-btn {
      position: fixed;
      /* âœ… è²¼åœ¨æ•´å€‹ç•«é¢å³ä¸‹è§’ */
      right: 24px;
      bottom: 24px;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      cursor: pointer;
      display: grid;
      place-items: center;
      background: rgba(0, 0, 0, 0.65);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
      z-index: 9999;
    }

    .slot-settings-btn:hover {
      transform: scale(1.06);
      border-color: rgba(122, 167, 255, 0.8);
    }

    .slot-settings-icon {
      width: 30px;
      height: 30px;
      object-fit: contain;
      display: none;
      /* æ²’è¼‰å…¥åœ–ç¤ºå°±å…ˆä¸é¡¯ç¤º */
    }

    .slot-settings-fallback {
      font-size: 22px;
      line-height: 1;
      color: #fff;
    }

    .slot-settings-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.62);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .slot-settings-modal.hidden {
      display: none !important;
    }

    .slot-settings-panel {
      width: min(92vw, 1000px);
      max-width: calc(100% - 28px);
      background: #121622;
      border-radius: 14px;
      border: 1px solid #2a3044;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      overflow: hidden;
    }


    .slot-settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 15px;
      font-weight: 600;
    }

    .slot-settings-header button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 6px;
    }

    .slot-settings-body {
      padding: 14px;
      color: #d3d6e4;
      font-size: 13px;
      line-height: 1.6em;
    }

    /* Slot settings: sections */
    .slot-settings-section {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .slot-settings-section:last-child {
      border-bottom: none;
    }

    .slot-settings-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
      font-size: 13px;
    }

    .slot-settings-toggle input {
      width: 16px;
      height: 16px;
    }

    .slot-settings-sub {
      margin-top: 10px;
      padding: 10px 10px;
      background: rgba(0, 0, 0, 0.22);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
    }

    .slot-settings-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .slot-settings-label {
      font-size: 12px;
      color: var(--muted);
    }

    .slot-settings-hint {
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    .slot-settings-search {
      width: 100%;
      margin-bottom: 10px;
    }

    .slot-settings-perkgrid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      max-height: 42vh;
      overflow: auto;
      padding-right: 6px;
    }

    @media (max-width: 520px) {
      .slot-settings-perkgrid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .ss-perk-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(11, 13, 23, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.06);
      cursor: pointer;
      transition: transform .06s, border-color .14s, background .14s;
    }

    .ss-perk-item:hover {
      transform: translateY(-1px);
      border-color: rgba(122, 167, 255, 0.65);
      background: rgba(21, 24, 36, 0.98);
    }

    .ss-perk-item.selected {
      border-color: rgba(122, 167, 255, 0.95);
      box-shadow: 0 0 0 1px rgba(63, 130, 255, 0.35);
      background: radial-gradient(circle at top left, rgba(63, 130, 255, 0.22), rgba(11, 13, 23, 0.98));
    }

    .ss-perk-thumb {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      background: #101320;
      border: 1px solid rgba(255, 255, 255, 0.12);
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 10px;
    }

    .ss-perk-thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .ss-perk-text {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .ss-perk-name {
      font-size: 12px;
      font-weight: 650;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ss-perk-zh {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .slot-settings-toggle input:disabled+span {
      opacity: 0.6;
    }
  </style>
</head>

<body>
  <div class="app">
    <h1>
      DBD æ®ºæ‰‹é…é» & æ‹‰éœ¸å·¥å…·
      <span class="small">ï¼ˆé…åˆ†æ¨¡å¼ + æ‹‰éœ¸æ¨¡å¼ï¼‰</span>
    </h1>

    <div class="top-row">
      <div class="mode-tabs">
        <button id="tabPoints" class="mode-tab active" type="button">é…åˆ†æ¨¡å¼</button>
        <button id="tabSlot" class="mode-tab" type="button">æ‹‰éœ¸æ¨¡å¼</button>
      </div>
    </div>

    <!-- === é…åˆ†æ¨¡å¼ === -->
    <div id="pointsMode" class="layout">
      <div class="points-layout">
        <!-- å·¦å´ï¼šæ®ºæ‰‹é¸æ“‡ + é…ä»¶ & æŠ€èƒ½åˆ—è¡¨ -->
        <div>
          <!-- æ®ºæ‰‹é¸æ“‡å€ -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">æ®ºæ‰‹é¸æ“‡</div>
                <div class="card-sub">å¯ä»¥ç”¨æœå°‹ï¼ˆä¸­ / è‹± / åˆ¥åï¼‰å¿«é€Ÿæ‰¾åˆ°è¦çš„æ®ºæ‰‹</div>
              </div>
            </div>
            <div class="row">
              <div class="flex-2">
                <div class="label">æœå°‹æ®ºæ‰‹</div>
                <input id="killerSearch" type="text" placeholder="ä¾‹ï¼šå¨å»‰ã€å‡œå¦¹ã€é–ƒé›»å¤§å¸¥å“¥â€¦" />
              </div>
              <div class="flex-1">
                <div class="label">é¸æ“‡æ®ºæ‰‹</div>
                <select id="killerSelect">
                  <option value="">è«‹é¸æ“‡æ®ºæ‰‹â€¦</option>
                </select>
              </div>
            </div>
          </div>

          <!-- é…ä»¶åˆ—è¡¨ -->
          <div class="card mt-8">
            <div class="card-header">
              <div>
                <div class="card-title">é…ä»¶åˆ—è¡¨</div>
                <div id="addonSubTitle" class="card-sub"></div>
              </div>
            </div>

            <div class="row">
              <div class="flex-2">
                <div class="label">é…ä»¶æœå°‹ï¼ˆä¸­ / è‹± / åˆ¥åï¼‰</div>
                <input id="addonSearch" type="text" placeholder="ä¾‹ï¼šè¿·å› é…ä»¶ã€é¤…ä¹¾å¤¾ã€æ°¸ä¸€â€¦" />
              </div>
              <div style="width: 150px; margin-left: auto;">
                <div class="label">åˆ†æ•¸éæ¿¾</div>
                <select id="addonScoreFilter">
                  <option value="">å…¨éƒ¨</option>
                  <option value="0"> 0 åˆ†</option>
                  <option value="1"> 1 åˆ†</option>
                  <option value="2"> 2 åˆ†</option>
                  <option value="3"> 3 åˆ†</option>
                  <option value="4"> 4 åˆ†</option>
                  <option value="5"> 5 åˆ†</option>
                </select>
              </div>
            </div>

            <div id="addonList" class="list-container"></div>

            <div class="section-note">é»æ“Šé…ä»¶å¡ç‰‡å³å¯åŠ å…¥ / ç§»é™¤ã€‚</div>
          </div>

          <!-- æŠ€èƒ½åˆ—è¡¨ -->
          <div class="card mt-8">
            <div class="card-header">
              <div>
                <div class="card-title">æŠ€èƒ½åˆ—è¡¨ï¼ˆPerksï¼‰</div>
                <div id="perkSubTitle" class="card-sub">å¾å…¨æ± ä¸­æŒ‘ 4 å€‹æŠ€èƒ½</div>
              </div>
            </div>

            <div class="row">
              <div class="flex-2">
                <div class="label">æŠ€èƒ½æœå°‹ï¼ˆä¸­ / è‹± / åˆ¥åï¼‰</div>
                <input id="perkSearch" type="text" placeholder="ä¾‹ï¼šè²å­çœ¼ã€è¶…é•·åˆ€ã€å¤©ç½é‰¤â€¦" />
              </div>
              <div style="width: 150px; margin-left: auto;">
                <div class="label">åˆ†æ•¸éæ¿¾</div>
                <select id="perkScoreFilter">
                  <option value="">å…¨éƒ¨</option>
                  <option value="0"> 0 åˆ†</option>
                  <option value="1"> 1 åˆ†</option>
                  <option value="2"> 2 åˆ†</option>
                  <option value="3"> 3 åˆ†</option>
                  <option value="4"> 4 åˆ†</option>
                  <option value="5"> 5 åˆ†</option>
                </select>
              </div>
            </div>

            <div id="perkList" class="list-container"></div>

            <div class="section-note">é»æ“ŠæŠ€èƒ½å¡ç‰‡å³å¯åŠ å…¥ / ç§»é™¤ã€‚</div>
          </div>
        </div>

        <!-- å³å´ï¼šç›®å‰é…ç½® -->
        <div>
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">ç›®å‰é…ç½®</div>
                <div class="card-sub">é¡¯ç¤ºç•¶å‰æ®ºæ‰‹ã€é…ä»¶èˆ‡æŠ€èƒ½ï¼ˆå³å´æŠ€èƒ½ç‚º 4 æ ¼åœ–ç¤ºï¼‰</div>
              </div>
              <button id="clearBuildBtn" type="button" class="outline">æ¸…ç©ºç›®å‰é…ç½®</button>
            </div>

            <!-- æ®ºæ‰‹ + é…ä»¶ ç‰ˆé¢ -->
            <div class="build-main-layout">
              <div class="kill-avatar-wrap">
                <div class="killer-box">
                  <div id="killerAvatar" class="killer-avatar">
                    å°šæœªé¸æ“‡
                  </div>
                  <div>
                    <div id="killerName" class="killer-name-main">â€”</div>
                    <div id="killerZh" class="killer-name-sub">è«‹å…ˆé¸æ“‡æ®ºæ‰‹</div>
                  </div>
                </div>
              </div>
              <div>
                <div class="label">å·²é¸é…ä»¶</div>
                <div id="selectedAddons" class="selected-grid"></div>
              </div>
            </div>

            <!-- æŠ€èƒ½ 4 æ ¼åœ–ç¤º -->
            <div class="mt-8">
              <div class="label">æŠ€èƒ½æ¬„ä½</div>
              <div class="skills-row" id="selectedPerkIcons">
                <!-- 4 å€‹ slot æœƒå‹•æ…‹å¡« -->
              </div>
            </div>

            <!-- ç¸½çµæ–‡å­— -->
            <div id="buildSummary" class="build-summary mt-8"></div>

            <!-- ç›®å‰åˆ†æ•¸å¡ç‰‡ -->
            <!-- â­ ç¨ç«‹çš„ç›®å‰é…åˆ†å¡ç‰‡ -->
            <div id="currentPointsCard" class="card mt-8">
              <div class="card-title" style="font-size:15px; font-weight:600;">ç›®å‰é…åˆ†</div>
              <div style="font-size:12px; color:#a6a9c0; margin-top:2px;">
                A = B - ( C + D )
              </div>

              <!-- å››å€‹å¤§æ•¸å­— -->
              <div style="display:flex; gap:32px; margin-top:10px; align-items:flex-end;">
                <div style="text-align:center;">
                  <div id="cp_A" style="font-size:28px; font-weight:700;">â€”</div>
                  <div style="font-size:12px; color:#a6a9c0;">å‰©é¤˜åˆ†æ•¸</div>
                </div>

                <div style="text-align:center;">
                  <div id="cp_B" style="font-size:22px; font-weight:600;">â€”</div>
                  <div style="font-size:12px; color:#a6a9c0;">æ®ºæ‰‹ä¸Šé™</div>
                </div>

                <div style="text-align:center;">
                  <div id="cp_C" style="font-size:22px; font-weight:600;">â€”</div>
                  <div style="font-size:12px; color:#a6a9c0;">é…ä»¶ç¸½åˆ†</div>
                </div>

                <div style="text-align:center;">
                  <div id="cp_D" style="font-size:22px; font-weight:600;">â€”</div>
                  <div style="font-size:12px; color:#a6a9c0;">æŠ€èƒ½ç¸½åˆ†</div>
                </div>
              </div>
            </div>

            <!-- å¹¸é‹ç¥ç±¤ï¼šé…åˆ†æ¨¡å¼åº•éƒ¨ -->
            <div id="fortuneRow"
              style="margin-top:16px; display:flex; align-items:center; gap:16px; justify-content:flex-end;">
              <!-- Dice Controls -->
              <button id="diceLeftBtn" type="button" title="æ¸…ç©ºç›®å‰é…ç½®"
                style="width:56px;height:56px;cursor:pointer;background:transparent;border:none;box-shadow:none;outline:none;padding:0;display:flex;align-items:center;justify-content:center;"><img
                  src="./images/other/éª°å­.png" alt="dice" class="dice-icon"></button>
              <button id="diceRightBtn" type="button" title="æ“²éª°(7~25)"
                style="width:56px;height:56px;cursor:pointer;background:transparent;border:none;box-shadow:none;outline:none;padding:0;display:flex;align-items:center;justify-content:center;">
                <img src="./images/other/éª°å­.png" alt="dice" class="dice-icon">
              </button>


              <img id="fortuneTubeBtn" src="./images/other/ç±¤ç­’.png" alt="æŠ½ç¥ç±¤"
                style="width:56px; height:56px; cursor:pointer; filter: drop-shadow(0 0 6px rgba(0,0,0,0.7));">
              <div id="fortuneResultIcon"
                style="width:56px; height:56px; border-radius:12px; border:1px solid rgba(255,255,255,0.25); background:#111320; display:none; cursor:pointer; overflow:hidden;">
                <img id="fortuneResultPerkImg" src="" alt="å¹¸é‹æŠ€èƒ½" style="width:100%; height:100%; object-fit:contain;">
              </div>
            </div>


          </div>
        </div>
      </div>
    </div>

    <!-- === æ‹‰éœ¸æ¨¡å¼ === -->
    <div id="slotMode" class="slot-section hidden">
      <div class="slot-machine">
        <div class="slot-header">
          <div class="slot-title-main">æ‹‰éœ¸æ¨¡å¼</div>
          <div class="slot-sub">æ‹‰ä¸‹æ‹‰æ¡¿å°±å¥½äº†å–”</div>
        </div>

        <div class="slot-inner">
          <div class="slot-board-wrapper">
            <div class="slot-board" id="slotBoard">
              <!-- 7 æ ¼ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
            </div>
          </div>

          <!-- æ‹‰æ¡¿ï¼šæ­£å¸¸ç‹€æ…‹ï¼ˆä¸Šæ–¹ç´…çƒ + æ¡¿å­ï¼‰ -->
          <div id="leverNormal" class="lever-normal">
            <div class="lever-stick">
              <div class="lever-ball"></div>
            </div>
          </div>

          <!-- æ‹‰æ¡¿ï¼šæ‹‰åˆ°åº•æ™‚åªé¡¯ç¤ºåº•éƒ¨ç´…çƒ -->
          <div id="leverBottom" class="lever-bottom">
            <div class="bottom-ball"></div>
          </div>

          <!-- å®Œæˆè¦†è“‹è¨Šæ¯ï¼ˆæŠ½æ»¿ 7 æ ¼æ™‚é¡¯ç¤ºï¼‰ -->
          <div id="slotOverlay" class="slot-overlay hidden" style="display:none;">
            ğŸ‰ å®Œæˆï¼ï¼ˆ3 ç§’å¾Œè‡ªå‹•é‡ç½®ï¼‰
          </div>
        </div>

        <!-- èˆŠçš„æŒ‰éˆ•æ”¹ç‚ºéš±è—ï¼Œåªçµ¦ JS ä½¿ç”¨ -->
        <button id="slotBtn" type="button" class="hidden">ğŸ° æŠ½ä¸€æ ¼</button>
        <button id="slotResetBtn" type="button" class="hidden">é‡ç½®æ‹‰éœ¸</button>

        <div class="slot-hint"></div>



      </div>

      <!-- Slot settings (Slot mode only) -->
      <button id="slotSettingsBtn" class="slot-settings-btn" type="button" title="è¨­å®š">
        <img id="slotSettingsIcon" class="slot-settings-icon" src="./images/other/è¨­å®š.png" alt="settings"
          onload="this.style.display='block'; this.nextElementSibling.style.display='none';"
          onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
        <span class="slot-settings-fallback">âš™</span>
      </button>

      <div id="slotSettingsModal" class="slot-settings-modal hidden" role="dialog" aria-modal="true">
        <div class="slot-settings-panel">
          <div class="slot-settings-header">
            <span>æ‹‰éœ¸è¨­å®š</span>
            <button id="closeSlotSettings" type="button" aria-label="é—œé–‰">âœ•</button>
          </div>
          <div class="slot-settings-body">
            <div class="slot-settings-section">
              <label class="slot-settings-toggle">
                <input id="ssLockKiller" type="checkbox" />
                <span>è‡ªé¸æ®ºæ‰‹</span>
              </label>
              <div id="ssLockKillerPanel" class="slot-settings-sub hidden">
                <div class="slot-settings-row">
                  <div class="slot-settings-label">é¸æ“‡æ®ºæ‰‹</div>
                  <select id="ssKillerSelect">
                    <option value="">è«‹é¸æ“‡æ®ºæ‰‹â€¦</option>
                  </select>
                </div>
                <div class="slot-settings-hint">é–‹å•Ÿå¾Œï¼šæ‹‰éœ¸æœƒå›ºå®šä½¿ç”¨ä½ é¸çš„æ®ºæ‰‹ï¼›å¡ç‰‡é€ æˆçš„ã€Œæ›æ®ºæ‰‹ã€æ•ˆæœå°‡è¢«å¿½ç•¥ã€‚</div>
              </div>
            </div>

            <div class="slot-settings-section">
              <label class="slot-settings-toggle">
                <input id="ssCustomPerks" type="checkbox" />
                <span>è‡ªé¸æŠ€èƒ½æ± </span>
              </label>
              <div id="ssCustomPerksPanel" class="slot-settings-sub hidden">
                <input id="ssPerkSearch" class="slot-settings-search" type="text" placeholder="æœå°‹æŠ€èƒ½ï¼ˆä¸­ / è‹± / åˆ¥åï¼‰" />
                <div class="slot-settings-perkgrid" id="ssPerkGrid"></div>
                <div class="slot-settings-hint">é–‹å•Ÿå¾Œï¼šæ‹‰éœ¸æŠ€èƒ½åªæœƒå¾ä½ å‹¾é¸çš„æŠ€èƒ½ä¸­æŠ½å–ï¼ˆä¸é¡¯ç¤ºé…åˆ†ï¼‰ã€‚</div>
              </div>
            </div>

            <div class="slot-settings-section">
              <label class="slot-settings-toggle">
                <input id="ssDisableCards" type="checkbox" />
                <span>åœç”¨å¡ç‰‡ç³»çµ±</span>
              </label>
              <div class="slot-settings-hint">æ‰“å‹¾å¾Œï¼šæ‹‰éœ¸æŠ½æ»¿å¾Œä¸æœƒå‡ºç¾å¡ç‰‡ï¼ˆç›´æ¥çµç®—ï¼‰ã€‚</div>
            </div>

            <div class="slot-settings-section">
              <label class="slot-settings-toggle">
                <input id="ssEnableSpecialCards" type="checkbox" />
                <span>å•Ÿç”¨ç‰¹æ®Šå¡</span>
              </label>
              <div class="slot-settings-hint">æ‰“å‹¾å¾Œï¼šç‰¹æ®Šå¡æ‰æœƒåŠ å…¥å¡æ± ï¼›å–æ¶ˆæ‰“å‹¾å‰‡æ°¸é ä¸æœƒæŠ½åˆ°ã€‚</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è³‡æ–™æª” -->
  <script src="killers.js"></script>
  <script src="addons.js"></script>
  <script src="perks.js"></script>
  <script src="card.js"></script>

  <script>
    // ========================================
    //(ï¾‰>Ï‰<)ï¾‰ âœ§        Ado          âœ§ãƒ½(>Ï‰<ãƒ½)
    //(ï¾‰>Ï‰<)ï¾‰ âœ§     è¶…ã‹ã‚ã„ã„ï¼     âœ§ãƒ½(>Ï‰<ãƒ½)
    //(ï¾‰>Ï‰<)ï¾‰ âœ§        Ado          âœ§ãƒ½(>Ï‰<ãƒ½)
    //(ï¾‰>Ï‰<)ï¾‰ âœ§    è¶…ã‹ã£ã“ã„ã„ï¼    âœ§ãƒ½(>Ï‰<ãƒ½)
    // ========================================

    // ==========================
    // å…¨åŸŸç‹€æ…‹ & DOM åƒç…§
    // ==========================
    const killerSelect = document.getElementById('killerSelect');
    const killerSearchInput = document.getElementById('killerSearch');

    const addonSearchInput = document.getElementById('addonSearch');
    const addonScoreFilter = document.getElementById('addonScoreFilter');
    const addonListEl = document.getElementById('addonList');
    const addonSubTitle = document.getElementById('addonSubTitle');

    const perkSearchInput = document.getElementById('perkSearch');
    const perkScoreFilter = document.getElementById('perkScoreFilter');
    const perkListEl = document.getElementById('perkList');
    const perkSubTitle = document.getElementById('perkSubTitle');

    const killerAvatarEl = document.getElementById('killerAvatar');
    const killerNameEl = document.getElementById('killerName');
    const killerZhEl = document.getElementById('killerZh');

    const selectedAddonsEl = document.getElementById('selectedAddons');
    const selectedPerkIconsEl = document.getElementById('selectedPerkIcons');
    const buildSummaryEl = document.getElementById('buildSummary');

    const currentPointsValueEl = document.getElementById('currentPointsValue');
    const currentPointsNoteEl = document.getElementById('currentPointsNote');

    const tabPoints = document.getElementById('tabPoints');
    const tabSlot = document.getElementById('tabSlot');
    const pointsModeEl = document.getElementById('pointsMode');
    const slotModeEl = document.getElementById('slotMode');

    const clearBuildBtn = document.getElementById('clearBuildBtn');

    const slotBoardEl = document.getElementById('slotBoard');
    const slotBtn = document.getElementById('slotBtn');
    const slotResetBtn = document.getElementById('slotResetBtn');
    const slotOverlayEl = document.getElementById('slotOverlay');
    const leverNormalEl = document.getElementById('leverNormal');
    const leverBottomEl = document.getElementById('leverBottom');


    // ==========================
    // Slot è¨­å®šéµï¼ˆåƒ…æ‹‰éœ¸æ¨¡å¼ï¼‰
    // ==========================
    const slotSettingsBtn = document.getElementById('slotSettingsBtn');
    const slotSettingsModal = document.getElementById('slotSettingsModal');
    const closeSlotSettingsBtn = document.getElementById('closeSlotSettings');

    function closeSlotSettings() {
      if (slotSettingsModal) slotSettingsModal.classList.add('hidden');
    }

    function openSlotSettings() {
      if (slotSettingsModal) slotSettingsModal.classList.remove('hidden');
    }

    if (slotSettingsBtn && slotSettingsModal && closeSlotSettingsBtn) {
      slotSettingsBtn.addEventListener('click', openSlotSettings);
      closeSlotSettingsBtn.addEventListener('click', closeSlotSettings);

      // é»é®ç½©é—œé–‰ï¼ˆé» panel ä¸é—œï¼‰
      slotSettingsModal.addEventListener('click', (e) => {
        if (e.target === slotSettingsModal) closeSlotSettings();
      });

      // ESC é—œé–‰
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeSlotSettings();
      });
    }

    // é è¨­åœ¨é…åˆ†æ¨¡å¼ï¼šå…ˆæŠŠå³ä¸‹è§’è¨­å®šéµè—èµ·ä¾†
    if (slotSettingsBtn) slotSettingsBtn.classList.add('hidden');

    /* åœ–ç¤ºè¼‰å…¥æˆåŠŸå°±é¡¯ç¤ºåœ–ç‰‡ï¼Œå¤±æ•—å°±ç”¨å‚™ç”¨ âš™ */
    const slotSettingsIcon = document.getElementById('slotSettingsIcon');
    const slotSettingsFallback = slotSettingsBtn ? slotSettingsBtn.querySelector('.slot-settings-fallback') : null;
    if (slotSettingsIcon && slotSettingsFallback) {
      slotSettingsIcon.addEventListener('load', () => {
        slotSettingsIcon.style.display = 'block';
        slotSettingsFallback.style.display = 'none';
      });
      slotSettingsIcon.addEventListener('error', () => {
        slotSettingsIcon.style.display = 'none';
        slotSettingsFallback.style.display = 'block';
      });
    }

    // ==========================
    // Slot Settings ç‹€æ…‹ï¼ˆä¾›æ‹‰éœ¸/å¡ç‰‡ä½¿ç”¨ï¼‰
    // ==========================
    (function initSlotSettings() {
      const DEFAULTS = {
        lockKiller: false,
        lockKillerKey: '',
        customPerksEnabled: false,
        allowedPerks: null, // array of perk keys (when enabled)
        cardsEnabled: true,
        specialCardsEnabled: true
      };

      function load() {
        try {
          const raw = localStorage.getItem('dbd_slot_settings');
          if (!raw) return { ...DEFAULTS };
          const parsed = JSON.parse(raw);
          return { ...DEFAULTS, ...(parsed || {}) };
        } catch (e) {
          return { ...DEFAULTS };
        }
      }

      function save() {
        try {
          localStorage.setItem('dbd_slot_settings', JSON.stringify(window.SlotSettings || DEFAULTS));
        } catch (e) { }
      }

      window.SlotSettings = load();
      window.saveSlotSettings = save;

      // ---- UI wiring ----
      const elLockKiller = document.getElementById('ssLockKiller');
      const elLockKillerPanel = document.getElementById('ssLockKillerPanel');
      const elKillerSelect = document.getElementById('ssKillerSelect');

      const elCustomPerks = document.getElementById('ssCustomPerks');
      const elCustomPerksPanel = document.getElementById('ssCustomPerksPanel');
      const elPerkSearch = document.getElementById('ssPerkSearch');
      const elPerkGrid = document.getElementById('ssPerkGrid');

      const elDisableCards = document.getElementById('ssDisableCards');
      const elEnableSpecial = document.getElementById('ssEnableSpecialCards');

      function setHidden(node, hidden) {
        if (!node) return;
        node.classList.toggle('hidden', !!hidden);
      }

      function populateKillerSelect() {
        if (!elKillerSelect || !window.KILLERS) return;
        elKillerSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ®ºæ‰‹â€¦</option>';
        const entries = Object.entries(window.KILLERS || {});
        for (const [key, killer] of entries) {
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = killer && killer.zh ? `${killer.zh} / ${key}` : key;
          elKillerSelect.appendChild(opt);
        }
      }

      function perkHaystack(perkKey) {
        const p = window.PERKS && window.PERKS[perkKey];
        const parts = [perkKey, (p && p.zh) || ''];
        const aliases = (p && p.aliases) || [];
        for (const a of aliases) parts.push(a);

        // === include killer info for searching perks by killer ===
        if (p && p.killer && window.KILLERS && window.KILLERS[p.killer]) {
          const k = window.KILLERS[p.killer];
          parts.push(p.killer);
          if (k.zh) parts.push(k.zh);
          const kAliases = k.aliases || [];
          for (const ka of kAliases) parts.push(ka);
        }
        return parts.join(' ').toLowerCase();
      }

      function ensureAllowedPerksDefault() {
        if (!window.PERKS) return;
        if (!Array.isArray(window.SlotSettings.allowedPerks) || window.SlotSettings.allowedPerks.length === 0) {
          window.SlotSettings.allowedPerks = Object.keys(window.PERKS || {});
        }
      }

      function renderPerkGrid(term) {
        if (!elPerkGrid || !window.PERKS) return;

        const lower = (term || '').trim().toLowerCase();
        const allowedSet = new Set(Array.isArray(window.SlotSettings.allowedPerks) ? window.SlotSettings.allowedPerks : []);

        elPerkGrid.innerHTML = '';
        const keys = Object.keys(window.PERKS || {}); // ä¿æŒç¨‹å¼å…§é †åº

        for (const perkKey of keys) {
          if (lower) {
            if (!perkHaystack(perkKey).includes(lower)) continue;
          }

          const p = window.PERKS[perkKey] || {};
          const item = document.createElement('div');
          item.className = 'ss-perk-item' + (allowedSet.has(perkKey) ? ' selected' : '');
          item.dataset.perkKey = perkKey;

          const thumb = document.createElement('div');
          thumb.className = 'ss-perk-thumb';
          if (p.img) {
            const img = document.createElement('img');
            img.src = p.img;
            img.alt = p.zh || perkKey;
            thumb.appendChild(img);
          } else {
            thumb.textContent = 'no img';
          }

          const text = document.createElement('div');
          text.className = 'ss-perk-text';
          const name = document.createElement('div');
          name.className = 'ss-perk-name';
          name.textContent = p.zh || perkKey;

          const zh = document.createElement('div');
          zh.className = 'ss-perk-zh';
          zh.textContent = (p.zh && p.zh !== perkKey) ? perkKey : (p.zh2 || ''); // è®“è‹±æ–‡èƒ½è¢«çœ‹åˆ°ä¸€é»ï¼Œä½†ä¸é¡¯ç¤ºåˆ†æ•¸

          text.appendChild(name);
          text.appendChild(zh);

          item.appendChild(thumb);
          item.appendChild(text);

          item.addEventListener('click', () => {
            if (!window.SlotSettings.customPerksEnabled) return;

            const set = new Set(Array.isArray(window.SlotSettings.allowedPerks) ? window.SlotSettings.allowedPerks : []);
            if (set.has(perkKey)) set.delete(perkKey);
            else set.add(perkKey);

            window.SlotSettings.allowedPerks = Array.from(set);
            save();
            renderPerkGrid(elPerkSearch ? elPerkSearch.value : '');
          });

          elPerkGrid.appendChild(item);
        }
      }

      function syncUIFromSettings() {
        if (elLockKiller) elLockKiller.checked = !!window.SlotSettings.lockKiller;
        if (elCustomPerks) elCustomPerks.checked = !!window.SlotSettings.customPerksEnabled;
        if (elDisableCards) elDisableCards.checked = (window.SlotSettings.cardsEnabled === false);
        if (elEnableSpecial) elEnableSpecial.checked = !!window.SlotSettings.specialCardsEnabled;

        setHidden(elLockKillerPanel, !window.SlotSettings.lockKiller);
        setHidden(elCustomPerksPanel, !window.SlotSettings.customPerksEnabled);

        // ç‰¹æ®Šå¡ï¼šå¡ç‰‡åœç”¨æ™‚ï¼Œä¸èƒ½å‹¾
        if (elEnableSpecial) {
          const cardsOff = (window.SlotSettings.cardsEnabled === false);
          elEnableSpecial.disabled = cardsOff;
          if (cardsOff) {
            elEnableSpecial.checked = false;
            window.SlotSettings.specialCardsEnabled = false;
          }
        }

        if (elKillerSelect) elKillerSelect.value = window.SlotSettings.lockKillerKey || '';

        if (window.SlotSettings.customPerksEnabled) ensureAllowedPerksDefault();
        renderPerkGrid(elPerkSearch ? elPerkSearch.value : '');
      }

      // Init once data available
      populateKillerSelect();
      syncUIFromSettings();

      // Events
      if (elLockKiller) {
        elLockKiller.addEventListener('change', () => {
          window.SlotSettings.lockKiller = !!elLockKiller.checked;
          if (window.SlotSettings.lockKiller) {
            // é è¨­ï¼šè‹¥ç›®å‰æ‹‰éœ¸å·²æŠ½åˆ°æ®ºæ‰‹ï¼Œå°±ä»¥å®ƒç‚ºé è¨­
            if (!window.SlotSettings.lockKillerKey) {
              if (window.slotState && window.slotState.killerKey) window.SlotSettings.lockKillerKey = window.slotState.killerKey;
            }
          }
          save();
          syncUIFromSettings();
        });
      }

      if (elKillerSelect) {
        elKillerSelect.addEventListener('change', () => {
          window.SlotSettings.lockKillerKey = elKillerSelect.value || '';
          save();
          // è‹¥æ‹‰éœ¸å·²ç¶“é–‹å§‹æŠ½äº†ï¼Œåˆ‡æ®ºæ‰‹æœƒé€ æˆé…ä»¶æ± ä¸ä¸€è‡´ â†’ ç›´æ¥ reset
          if (window.resetSlotState && window.slotState) {
            const started = !!(window.slotState.killerKey || (window.slotState.addons && window.slotState.addons.length) || (window.slotState.perks && window.slotState.perks.length));
            if (started) window.resetSlotState();
          }
        });
      }

      if (elCustomPerks) {
        elCustomPerks.addEventListener('change', () => {
          window.SlotSettings.customPerksEnabled = !!elCustomPerks.checked;
          if (window.SlotSettings.customPerksEnabled) ensureAllowedPerksDefault();
          save();
          syncUIFromSettings();
        });
      }

      if (elPerkSearch) {
        elPerkSearch.addEventListener('input', () => {
          renderPerkGrid(elPerkSearch.value);
        });
      }

      if (elDisableCards) {
        elDisableCards.addEventListener('change', () => {
          window.SlotSettings.cardsEnabled = !elDisableCards.checked;
          // å¡ç‰‡åœç”¨æ™‚é †ä¾¿é—œæ‰ç‰¹æ®Šå¡
          if (window.SlotSettings.cardsEnabled === false) window.SlotSettings.specialCardsEnabled = false;
          save();
          syncUIFromSettings();

          // ç«‹åˆ»æŠŠç•«é¢ä¸Šçš„å¡ç‰‡æ”¶èµ·ä¾†
          const cardContainer = document.getElementById('cardContainer');
          if (cardContainer) {
            cardContainer.innerHTML = '';
            cardContainer.classList.remove('card-visible');
            if (window.SlotSettings.cardsEnabled === false) {
              cardContainer.classList.add('hidden');
            } else {
              cardContainer.classList.remove('hidden');
            }
          }
        });
      }

      if (elEnableSpecial) {
        elEnableSpecial.addEventListener('change', () => {
          window.SlotSettings.specialCardsEnabled = !!elEnableSpecial.checked;
          save();
          syncUIFromSettings();
        });
      }
    })();



    let currentMode = 'points';
    let currentKillerKey = null;

    // é…åˆ†æ¨¡å¼é¸ä¸­çš„é…ä»¶ / æŠ€èƒ½
    let selectedAddons = []; // array of addon name
    let selectedPerks = [];  // array of perk name

    // æ®ºæ‰‹åŸå§‹åˆ—è¡¨ï¼ˆç”¨æ–¼æœå°‹ï¼‰
    let allKillerEntries = [];

    // æ‹‰éœ¸æ¨¡å¼ç‹€æ…‹
    const slotState = {
      killerKey: null,
      addons: [], // 2
      perks: [],  // 4
      locked: false,
      animTimeout: null,
      afterFull: false,
    };
    // è®“è¨­å®šç³»çµ±/å¡ç‰‡ç³»çµ±å¯è®€å–æ‹‰éœ¸ç‹€æ…‹
    window.slotState = slotState;


    // ==========================
    // åˆå§‹åŒ–æ®ºæ‰‹ä¸‹æ‹‰ + æœå°‹
    // ==========================
    function initKillerData() {
      if (!window.KILLERS) {
        console.error('KILLERS æœªå®šç¾©ï¼Œè«‹ç¢ºèª killers.js å·²è¼‰å…¥');
        return;
      }
      allKillerEntries = Object.entries(KILLERS).map(([key, killer]) => ({ key, killer }));
      rebuildKillerOptions('');
    }

    function rebuildKillerOptions(term) {
      const lower = (term || '').trim().toLowerCase();
      killerSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ®ºæ‰‹â€¦</option>';

      for (const { key, killer } of allKillerEntries) {
        if (lower) {
          const haystack = [
            key,
            killer.zh || '',
            ...(killer.aliases || [])
          ].join(' ').toLowerCase();
          if (!haystack.includes(lower)) continue;
        }
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = killer.zh ? `${killer.zh} / ${key}` : key;
        killerSelect.appendChild(opt);
      }

      if (currentKillerKey && Array.from(killerSelect.options).some(o => o.value === currentKillerKey)) {
        killerSelect.value = currentKillerKey;
      } else if (!currentKillerKey) {
        killerSelect.value = '';
      }
    }

    // ==========================
    // è¨ˆç®— / é¡¯ç¤ºé…åˆ†
    // ==========================
    function computePoints() {
      if (!currentKillerKey || !window.KILLERS) return { limit: 0, usedAddons: 0, usedPerks: 0 };

      const killer = KILLERS[currentKillerKey] || {};
      const baseLimit = Number(killer.limit ?? 0);
      const limit = (window.DICE_TOTAL_OVERRIDE != null) ? Number(window.DICE_TOTAL_OVERRIDE) : baseLimit;

      let usedAddons = 0;
      for (const name of selectedAddons) {
        const addon = ADDONS?.[name];
        if (!addon) continue;
        usedAddons += Number(addon.score ?? 0);
      }

      let usedPerks = 0;
      for (const name of selectedPerks) {
        const perk = PERKS?.[name];
        if (!perk) continue;
        usedPerks += Number(perk.score ?? 0);
      }

      return { limit, usedAddons, usedPerks };
    }

    // åªè² è²¬æ›´æ–°ã€Œç›®å‰åˆ†æ•¸ã€å¡ç‰‡
    function updatePointsDisplay() {
      const A = document.getElementById("cp_A");
      const B = document.getElementById("cp_B");
      const C = document.getElementById("cp_C");
      const D = document.getElementById("cp_D");

      if (!currentKillerKey) {
        A.textContent = B.textContent = C.textContent = D.textContent = "â€”";
        A.style.color = "#ffffff";
        return;
      }

      const { limit, usedAddons, usedPerks } = computePoints();

      // ä¾ç…§åœ–ç‰‡å…¬å¼ï¼šA = B - (C + D)
      const remaining = limit - (usedAddons + usedPerks);

      // å››é …å¤§æ•¸å­—
      A.textContent = remaining;
      B.textContent = limit;
      C.textContent = usedAddons;
      D.textContent = usedPerks;

      // é¡è‰²ï¼ˆåªå½±éŸ¿ Aï¼‰
      if (remaining > 0) {
        A.style.color = "#7CFF8A"; // ç¶ è‰²
      } else if (remaining === 0) {
        A.style.color = "#FFFFFF"; // ç™½è‰²
      } else {
        A.style.color = "#FF4B5C"; // ç´…è‰²
      }
    }


    // ==========================
    // æ¸²æŸ“å³å´ï¼šæ®ºæ‰‹ã€é…ä»¶ã€æŠ€èƒ½åœ–ç¤º
    // ==========================
    function renderKillerInfo() {
      if (!currentKillerKey || !window.KILLERS) {
        killerAvatarEl.innerHTML = 'å°šæœªé¸æ“‡';
        killerNameEl.textContent = 'â€”';
        killerZhEl.textContent = 'è«‹å…ˆé¸æ“‡æ®ºæ‰‹';
        return;
      }
      const killer = KILLERS[currentKillerKey];
      killerAvatarEl.innerHTML = '';
      if (killer.img) {
        const img = document.createElement('img');
        img.src = killer.img;
        img.alt = currentKillerKey;
        killerAvatarEl.appendChild(img);
      } else {
        killerAvatarEl.textContent = 'No Img';
      }
      killerNameEl.textContent = currentKillerKey;
      killerZhEl.textContent = killer.zh || 'ï¼ˆç„¡ä¸­æ–‡åç¨±ï¼‰';
    }

    function renderSelectedAddons() {
      selectedAddonsEl.innerHTML = '';
      if (!selectedAddons.length) {
        const span = document.createElement('span');
        span.style.color = 'var(--muted)';
        span.textContent = 'å°šæœªé¸æ“‡é…ä»¶';
        selectedAddonsEl.appendChild(span);
        return;
      }
      for (const name of selectedAddons) {
        const addon = ADDONS?.[name];
        if (!addon) continue;

        const pill = document.createElement('div');
        pill.className = 'selected-pill';

        if (addon.img) {
          const img = document.createElement('img');
          img.src = addon.img;
          img.alt = name;
          pill.appendChild(img);
        }

        const remove = document.createElement('span');
        remove.className = 'pill-remove';
        remove.textContent = 'Ã—';
        remove.title = 'ç§»é™¤æ­¤é…ä»¶';
        remove.onclick = () => {
          selectedAddons = selectedAddons.filter(n => n !== name);
          renderSelectedAddons();
          renderSelectedPerkIcons();
          updatePointsDisplay();
          renderAddonList();
        };
        pill.appendChild(remove);

        selectedAddonsEl.appendChild(pill);
      }
    }

    function renderSelectedPerkIcons() {
      selectedPerkIconsEl.innerHTML = '';
      for (let i = 0; i < 4; i++) {
        const slot = document.createElement('div');
        slot.className = 'skill-slot';

        const perkName = selectedPerks[i];
        if (!perkName) {
          const span = document.createElement('span');
          span.className = 'placeholder';
          span.textContent = 'ç©º';
          slot.appendChild(span);
        } else {
          const perk = PERKS?.[perkName];
          slot.classList.add('filled');
          if (perk && perk.img) {
            const img = document.createElement('img');
            img.src = perk.img;
            img.alt = perkName;
            const zh = perk.zh || '';
            const score = perk.score ?? 0;
            img.title = `${perkName}${zh ? ' / ' + zh : ''}ï¼ˆ${score} åˆ†ï¼‰\né»æ“Šç§»é™¤`;
            img.onclick = () => {
              selectedPerks = selectedPerks.filter(n => n !== perkName);
              renderSelectedPerkIcons();
              renderSelectedAddons();
              updatePointsDisplay();
              renderPerkList();
            };
            slot.appendChild(img);
          } else {
            const span = document.createElement('span');
            span.className = 'placeholder';
            span.textContent = perkName;
            slot.appendChild(span);
          }
        }
        selectedPerkIconsEl.appendChild(slot);
      }

      const { limit, usedAddons, usedPerks } = computePoints();
      if (!currentKillerKey) {
        buildSummaryEl.textContent = '';
        return;
      }
      const totalUsed = usedAddons + usedPerks;
      const remaining = limit - totalUsed;
      // ======== æ–°å¢ï¼šå–å¾—é…ä»¶ä¸­æ–‡ï¼‹è‹±æ–‡ ========
      const addonNames = selectedAddons
        .map(a => {
          const data = ADDONS[a];
          const zh = data?.zh ? ` / ${data.zh}` : "";
          return `${a}${zh}`;
        })
        .join("ã€");

      // ======== æ–°å¢ï¼šå–å¾—æŠ€èƒ½ä¸­æ–‡ï¼‹è‹±æ–‡ ========
      const perkNames = selectedPerks
        .map(p => {
          const data = PERKS[p];
          const zh = data?.zh ? ` / ${data.zh}` : "";
          return `${p}${zh}`;
        })
        .join("ã€");

      buildSummaryEl.innerHTML =
        `æ®ºæ‰‹ï¼š<strong>${currentKillerKey}</strong><br>` +
        `é…ä»¶ï¼ˆ${selectedAddons.length} å€‹ / ${usedAddons} åˆ†ï¼‰ï¼š<strong>${addonNames || "â€”"}</strong><br>` +
        `æŠ€èƒ½ï¼ˆ${selectedPerks.length} å€‹ / ${usedPerks} åˆ†ï¼‰ï¼š<strong>${perkNames || "â€”"}</strong><br>` +
        `å‰©é¤˜ï¼š<strong>${remaining}</strong>`;
    }



    // ==========================
    // é…ä»¶ / æŠ€èƒ½åˆ—è¡¨ï¼ˆå·¦å´ï¼‰
    // ==========================
    function getFilteredAddons() {
      if (!currentKillerKey || !window.ADDONS) return [];
      const term = (addonSearchInput.value || '').trim().toLowerCase();
      const scoreFilterValue = addonScoreFilter.value;
      const exactScore = scoreFilterValue === '' ? null : Number(scoreFilterValue);

      const result = [];
      for (const [name, addon] of Object.entries(ADDONS)) {
        if (addon.killer !== currentKillerKey) continue;

        const score = Number(addon.score ?? 0);
        if (exactScore !== null && score !== exactScore) continue;

        if (term) {
          const zh = (addon.zh || '').toLowerCase();
          const aliases = (addon.aliases || []).join(' ').toLowerCase();
          let killerPart = '';
          if (perk.killer && window.KILLERS && window.KILLERS[perk.killer]) {
            const k = window.KILLERS[perk.killer];
            killerPart = `${perk.killer} ${(k.zh || '')} ${(k.aliases || []).join(' ')}`.toLowerCase();
          }
          const combined = `${name.toLowerCase()} ${zh} ${aliases} ${killerPart}`;
          if (!combined.includes(term)) continue;
        }
        result.push([name, addon]);
      }

      result.sort((a, b) => {
        const sA = Number(a[1].score ?? 0);
        const sB = Number(b[1].score ?? 0);
        if (sA !== sB) return sA - sB;
        return a[0].localeCompare(b[0]);
      });

      return result;
    }

    function renderAddonList() {
      addonListEl.innerHTML = '';
      if (!currentKillerKey) {
        addonSubTitle.textContent = 'è«‹å…ˆé¸æ“‡æ®ºæ‰‹';
        return;
      }
      const list = getFilteredAddons();
      const total = Object.values(ADDONS || {}).filter(a => a.killer === currentKillerKey).length;
      addonSubTitle.textContent = `é¡¯ç¤º ${list.length} / ${total} å€‹é…ä»¶`;

      if (!list.length) {
        const div = document.createElement('div');
        div.style.color = 'var(--muted)';
        div.style.fontSize = '13px';
        div.textContent = 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é…ä»¶ã€‚';
        addonListEl.appendChild(div);
        return;
      }

      for (const [name, addon] of list) {
        const item = document.createElement('div');
        const isSelected = selectedAddons.includes(name);
        item.className = 'addon-item' + (isSelected ? ' selected' : '');

        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        if (addon.img) {
          const img = document.createElement('img');
          img.src = addon.img;
          img.alt = name;
          thumb.appendChild(img);
        } else {
          thumb.textContent = 'No Img';
        }

        const main = document.createElement('div');
        main.className = 'list-main';
        const title = document.createElement('div');
        title.className = 'list-name';
        title.textContent = name;
        const zh = document.createElement('div');
        zh.className = 'list-zh';
        zh.textContent = addon.zh || 'ï¼ˆç„¡ä¸­æ–‡åç¨±ï¼‰';

        main.appendChild(title);
        main.appendChild(zh);

        const tags = document.createElement('div');
        tags.className = 'tags-row';

        const scoreTag = document.createElement('span');
        scoreTag.className = 'tag tag-score';
        scoreTag.textContent = `åˆ†æ•¸ï¼š${addon.score ?? 0}`;
        tags.appendChild(scoreTag);

        const killerTag = document.createElement('span');
        killerTag.className = 'tag';
        const killer = KILLERS[addon.killer];
        killerTag.textContent = killer?.zh ? `${killer.zh} / ${addon.killer}` : addon.killer;
        tags.appendChild(killerTag);

        main.appendChild(tags);

        const right = document.createElement('div');
        right.className = 'list-right';
        const hint = document.createElement('div');
        hint.textContent = isSelected ? 'å·²åŠ å…¥' : 'é»æ“ŠåŠ å…¥';
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = isSelected ? 'é¸ä¸­' : 'æœªé¸ä¸­';
        right.appendChild(hint);
        right.appendChild(badge);

        item.appendChild(thumb);
        item.appendChild(main);
        item.appendChild(right);

        item.onclick = () => {
          if (isSelected) {
            selectedAddons = selectedAddons.filter(n => n !== name);
          } else {
            if (selectedAddons.length >= 2) {
              alert('é…ä»¶æœ€å¤šåªèƒ½é¸ 2 å€‹ã€‚');
              return;
            }
            selectedAddons.push(name);
          }
          renderSelectedAddons();
          renderSelectedPerkIcons();
          updatePointsDisplay();
          renderAddonList();
        };

        addonListEl.appendChild(item);
      }
    }

    function getFilteredPerks() {
      if (!window.PERKS) return [];
      const term = (perkSearchInput.value || '').trim().toLowerCase();
      const scoreFilterValue = perkScoreFilter.value;
      const exactScore = scoreFilterValue === '' ? null : Number(scoreFilterValue);

      const result = [];
      for (const [name, perk] of Object.entries(PERKS)) {
        const score = Number(perk.score ?? 0);
        if (exactScore !== null && score !== exactScore) continue;

        if (term) {
          const zh = (perk.zh || '').toLowerCase();
          const aliases = (perk.aliases || []).join(' ').toLowerCase();
          let killerPart = '';
          if (perk.killer && window.KILLERS && window.KILLERS[perk.killer]) {
            const k = window.KILLERS[perk.killer];
            killerPart = `${perk.killer} ${(k.zh || '')} ${(k.aliases || []).join(' ')}`.toLowerCase();
          }
          const combined = `${name.toLowerCase()} ${zh} ${aliases} ${killerPart}`;
          if (!combined.includes(term)) continue;
        }
        result.push([name, perk]);
      }

      result.sort((a, b) => {
        const sA = Number(a[1].score ?? 0);
        const sB = Number(b[1].score ?? 0);
        if (sA !== sB) return sA - sB;
        return a[0].localeCompare(b[0]);
      });

      return result;
    }

    function renderPerkList() {
      perkListEl.innerHTML = '';
      const list = getFilteredPerks();
      perkSubTitle.textContent = `é¡¯ç¤º ${list.length} å€‹æŠ€èƒ½`;

      if (!list.length) {
        const div = document.createElement('div');
        div.style.color = 'var(--muted)';
        div.style.fontSize = '13px';
        div.textContent = 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æŠ€èƒ½ã€‚';
        perkListEl.appendChild(div);
        return;
      }

      for (const [name, perk] of list) {
        const item = document.createElement('div');
        const isSelected = selectedPerks.includes(name);
        item.className = 'perk-item' + (isSelected ? ' selected' : '');

        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        if (perk.img) {
          const img = document.createElement('img');
          img.src = perk.img;
          img.alt = name;
          thumb.appendChild(img);
        } else {
          thumb.textContent = 'No Img';
        }

        const main = document.createElement('div');
        main.className = 'list-main';
        const title = document.createElement('div');
        title.className = 'list-name';
        title.textContent = name;
        const zh = document.createElement('div');
        zh.className = 'list-zh';
        zh.textContent = perk.zh || 'ï¼ˆç„¡ä¸­æ–‡åç¨±ï¼‰';

        main.appendChild(title);
        main.appendChild(zh);

        const tags = document.createElement('div');
        tags.className = 'tags-row';

        const scoreTag = document.createElement('span');
        scoreTag.className = 'tag tag-score';
        scoreTag.textContent = `åˆ†æ•¸ï¼š${perk.score ?? 0}`;
        tags.appendChild(scoreTag);

        main.appendChild(tags);

        const right = document.createElement('div');
        right.className = 'list-right';
        const hint = document.createElement('div');
        hint.textContent = isSelected ? 'å·²åŠ å…¥' : 'é»æ“ŠåŠ å…¥';
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = isSelected ? 'é¸ä¸­' : 'æœªé¸ä¸­';
        right.appendChild(hint);
        right.appendChild(badge);

        item.appendChild(thumb);
        item.appendChild(main);
        item.appendChild(right);

        item.onclick = () => {
          if (isSelected) {
            selectedPerks = selectedPerks.filter(n => n !== name);
          } else {
            if (selectedPerks.length >= 4) {
              alert('æŠ€èƒ½æœ€å¤šåªèƒ½é¸ 4 å€‹ã€‚');
              return;
            }
            selectedPerks.push(name);
          }
          renderSelectedPerkIcons();
          renderSelectedAddons();
          updatePointsDisplay();
          renderPerkList();
        };

        perkListEl.appendChild(item);
      }
    }

    // ==========================
    // æ‹‰éœ¸æ¨¡å¼
    // ==========================
    function initSlotBoard() {
      slotBoardEl.innerHTML = '';

      const labels = [
        'æ®ºæ‰‹',
        'é…ä»¶ 1',
        'é…ä»¶ 2',
        'æŠ€èƒ½ 1',
        'æŠ€èƒ½ 2',
        'æŠ€èƒ½ 3',
        'æŠ€èƒ½ 4'
      ];

      for (let i = 0; i < 7; i++) {
        const cell = document.createElement('div');
        cell.className = 'slot-cell';
        cell.dataset.index = i;

        const label = document.createElement('div');
        label.className = 'slot-cell-label';
        label.textContent = labels[i];

        const icon = document.createElement('div');
        icon.className = 'slot-icon';
        icon.textContent = 'â€”';

        const name = document.createElement('div');
        name.className = 'slot-name';
        name.textContent = '';

        cell.appendChild(label);
        cell.appendChild(icon);
        cell.appendChild(name);
        slotBoardEl.appendChild(cell);
      }
    }

    function renderSlotBoard() {
      const cells = Array.from(slotBoardEl.querySelectorAll('.slot-cell'));

      // killer slot
      const killerCell = cells[0];
      const killerIcon = killerCell.querySelector('.slot-icon');
      const killerName = killerCell.querySelector('.slot-name');
      killerIcon.innerHTML = '';
      killerName.textContent = '';

      if (slotState.killerKey && KILLERS[slotState.killerKey]) {
        const killer = KILLERS[slotState.killerKey];
        const img = document.createElement('img');
        img.src = killer.img || '';
        img.alt = slotState.killerKey;
        img.title = killer.zh ? `${slotState.killerKey} / ${killer.zh}` : slotState.killerKey;
        killerIcon.appendChild(img);
        killerName.textContent = killer.zh ? `${killer.zh} / ${slotState.killerKey}` : slotState.killerKey;
      } else {
        killerIcon.textContent = 'â€”';
      }

      // addon slots (1,2)
      for (let i = 0; i < 2; i++) {
        const cell = cells[1 + i];
        const icon = cell.querySelector('.slot-icon');
        const nameEl = cell.querySelector('.slot-name');
        icon.innerHTML = '';
        nameEl.textContent = '';

        const addonName = slotState.addons[i];
        if (addonName && ADDONS[addonName]) {
          const addon = ADDONS[addonName];
          const img = document.createElement('img');
          img.src = addon.img || '';
          img.alt = addonName;
          const zh = addon.zh || '';
          img.title = zh ? `${addonName} / ${zh}` : addonName;
          icon.appendChild(img);
          nameEl.textContent = zh ? `${addonName} / ${zh}` : addonName;
        } else {
          icon.textContent = 'â€”';
        }
      }

      // perk slots (3,4,5,6)
      for (let i = 0; i < 4; i++) {
        const cell = cells[3 + i];
        const icon = cell.querySelector('.slot-icon');
        const nameEl = cell.querySelector('.slot-name');
        icon.innerHTML = '';
        nameEl.textContent = '';

        const perkName = slotState.perks[i];
        if (perkName && PERKS[perkName]) {
          const perk = PERKS[perkName];
          const img = document.createElement('img');
          img.src = perk.img || '';
          img.alt = perkName;
          const zh = perk.zh || '';
          img.title = zh ? `${perkName} / ${zh}` : perkName;
          icon.appendChild(img);
          nameEl.textContent = zh ? `${perkName} / ${zh}` : perkName;
        } else {
          icon.textContent = 'â€”';
        }
      }
    }

    function resetSlotState() {
      slotState.killerKey = null;
      slotState.addons = [];
      slotState.perks = [];
      slotState.locked = false;
      slotState.afterFull = false;

      if (slotState.animTimeout) {
        clearTimeout(slotState.animTimeout);
        slotState.animTimeout = null;
      }

      slotBoardEl.classList.remove('win-anim');
      if (slotOverlayEl) slotOverlayEl.classList.add('hidden');

      const machineEl = document.querySelector('.slot-machine');
      if (machineEl) {
        machineEl.classList.remove('glow');
      }

      slotBtn.disabled = false;
      slotBtn.textContent = 'ğŸ° æŠ½ä¸€æ ¼';

      renderSlotBoard();
    }

    // è®“å¡ç‰‡ç³»çµ±/è¨­å®šç³»çµ±å¯å‘¼å« reset
    window.resetSlotState = resetSlotState;

    function getRandomItem(arr) {
      if (!arr.length) return null;
      const idx = Math.floor(Math.random() * arr.length);
      return arr[idx];
    }

    function drawOneSlot() {
      if (slotState.locked || slotState.afterFull) return;

      const filledCount =
        (slotState.killerKey ? 1 : 0) +
        slotState.addons.length +
        slotState.perks.length;

      if (filledCount >= 7) return;

      const step = filledCount;

      if (step === 0) {
        const settings = window.SlotSettings || {};
        if (settings.lockKiller && settings.lockKillerKey) {
          slotState.killerKey = settings.lockKillerKey;
        } else {
          const killerKeys = Object.keys(KILLERS || {});
          if (!killerKeys.length) return;
          slotState.killerKey = getRandomItem(killerKeys);
        }

      } else if (step === 1 || step === 2) {
        const pool = Object.entries(ADDONS || {})
          .filter(([name, a]) =>
            a &&
            a.killer === slotState.killerKey &&
            !slotState.addons.includes(name)
          )
          .map(([name]) => name);

        if (!pool.length) return;
        const chosen = getRandomItem(pool);
        if (chosen) slotState.addons.push(chosen);

      } else {
        const settings = window.SlotSettings || {};
        const used = new Set(slotState.perks);

        // è‡ªé¸æŠ€èƒ½æ± ï¼šåªå…è¨±å‹¾é¸çš„æŠ€èƒ½
        let allowedSet = null;
        if (settings.customPerksEnabled && Array.isArray(settings.allowedPerks)) {
          allowedSet = new Set(settings.allowedPerks);
        }

        const pool = Object.entries(PERKS || {})
          .filter(([perkName, perk]) => {
            if (used.has(perkName)) return false;
            if (!perk || typeof perk !== 'object') return false;
            if (allowedSet && !allowedSet.has(perkName)) return false;
            return true;
          })
          .map(([name]) => name);

        if (!pool.length) return;
        const chosen = getRandomItem(pool);
        if (chosen) slotState.perks.push(chosen);
      }


      renderSlotBoard();

      const newCount =
        (slotState.killerKey ? 1 : 0) +
        slotState.addons.length +
        slotState.perks.length;

      if (newCount >= 7) {
        slotState.locked = true;
        slotState.afterFull = true;

        if (window.CardSystem && typeof CardSystem.startCardPhase === 'function') {
          try {
            CardSystem.startCardPhase(slotState, {
              onApplied: (updatedState) => {
                if (updatedState) {
                  // å…ˆè¨˜éŒ„èˆŠç‹€æ…‹ï¼Œç”¨ä¾†åˆ¤æ–·å“ªäº›æ ¼å­æœ‰è®ŠåŒ–
                  const prevState = {
                    killerKey: slotState.killerKey,
                    addons: Array.isArray(slotState.addons) ? [...slotState.addons] : [],
                    perks: Array.isArray(slotState.perks) ? [...slotState.perks] : []
                  };

                  const changedIndices = [];

                  // æ®ºæ‰‹æ ¼ï¼šindex 0
                  {
                    const settings = window.SlotSettings || {};
                    const effectiveKillerKey = (settings.lockKiller && settings.lockKillerKey) ? settings.lockKillerKey : updatedState.killerKey;
                    if (typeof effectiveKillerKey !== 'undefined' && effectiveKillerKey !== prevState.killerKey) {
                      changedIndices.push(0);
                    }
                  }

                  // é…ä»¶æ ¼ï¼šindex 1,2
                  if (Array.isArray(updatedState.addons)) {
                    for (let i = 0; i < 2; i++) {
                      const beforeAddon = prevState.addons[i] || null;
                      const afterAddon = updatedState.addons[i] || null;
                      if (beforeAddon !== afterAddon) {
                        changedIndices.push(1 + i);
                      }
                    }
                  }

                  // æŠ€èƒ½æ ¼ï¼šindex 3,4,5,6
                  if (Array.isArray(updatedState.perks)) {
                    for (let i = 0; i < 4; i++) {
                      const beforePerk = prevState.perks[i] || null;
                      const afterPerk = updatedState.perks[i] || null;
                      if (beforePerk !== afterPerk) {
                        changedIndices.push(3 + i);
                      }
                    }
                  }

                  const uniqueChanged = [...new Set(changedIndices)];
                  const hasChanged = uniqueChanged.length > 0;

                  if (!hasChanged) {
                    // æ²’æ±è¥¿è®ŠåŒ–å°±æ­£å¸¸å¥—ç”¨
                    const settings = window.SlotSettings || {};
                    if (typeof updatedState.killerKey !== 'undefined') {
                      // è‡ªé¸æ®ºæ‰‹é–‹å•Ÿæ™‚ï¼šå¡ç‰‡é€ æˆçš„æ›æ®ºæ‰‹æ•ˆæœä¸å½±éŸ¿
                      if (settings.lockKiller && settings.lockKillerKey) {
                        slotState.killerKey = settings.lockKillerKey;
                      } else {
                        slotState.killerKey = updatedState.killerKey;
                      }
                    }
                    if (Array.isArray(updatedState.addons)) {
                      slotState.addons = [...updatedState.addons];
                    }
                    if (Array.isArray(updatedState.perks)) {
                      slotState.perks = [...updatedState.perks];
                    }
                    renderSlotBoard();
                  } else {
                    const cells = Array.from(slotBoardEl.querySelectorAll('.slot-cell'));
                    const DURATION = 300;

                    // å…ˆè®“èˆŠçš„åœ–ç¤ºå¾€ä¸Šæ·¡å‡º
                    uniqueChanged.forEach((idx) => {
                      const cell = cells[idx];
                      if (cell) {
                        cell.classList.add('slot-anim-out');
                      }
                    });

                    setTimeout(() => {
                      // å¥—ç”¨æ–°ç‹€æ…‹
                      if (typeof updatedState.killerKey !== 'undefined') {
                        slotState.killerKey = updatedState.killerKey;
                      }
                      if (Array.isArray(updatedState.addons)) {
                        slotState.addons = [...updatedState.addons];
                      }
                      if (Array.isArray(updatedState.perks)) {
                        slotState.perks = [...updatedState.perks];
                      }

                      // é‡ç•«æ•´å€‹ board
                      renderSlotBoard();

                      // è®“æ–°çš„åœ–ç¤ºç”±ä¸‹å¾€ä¸Šæ·¡å…¥
                      const freshCells = Array.from(slotBoardEl.querySelectorAll('.slot-cell'));
                      uniqueChanged.forEach((idx) => {
                        const cell = freshCells[idx];
                        if (cell) {
                          cell.classList.remove('slot-anim-out');
                          cell.classList.add('slot-anim-in');
                          setTimeout(() => {
                            cell.classList.remove('slot-anim-in');
                          }, DURATION);
                        }
                      });
                    }, DURATION);
                  }
                }
                slotState.locked = false;
              }
            });
          } catch (e) {
            console.error('CardSystem.startCardPhase ç™¼ç”ŸéŒ¯èª¤ï¼š', e);
            slotState.locked = false;
          }
        } else {
          slotState.locked = false;
        }
      }
    }

    // ==========================
    // äº‹ä»¶ç¶å®š & åˆå§‹åŒ–
    // ==========================
    // æ¨¡å¼åˆ‡æ›
    tabPoints.addEventListener('click', () => {
      if (currentMode === 'points') return;
      currentMode = 'points';
      tabPoints.classList.add('active');
      tabSlot.classList.remove('active');
      pointsModeEl.classList.remove('hidden');
      slotModeEl.classList.add('hidden');

      // é…åˆ†æ¨¡å¼ï¼šéš±è—å³ä¸‹è§’æ‹‰éœ¸è¨­å®šéµ
      if (slotSettingsBtn) slotSettingsBtn.classList.add('hidden');
      closeSlotSettings();

      // åˆ‡åˆ°é…åˆ†æ¨¡å¼æ™‚ï¼Œéš±è—æ‹‰éœ¸å¡ç‰‡å€åŸŸï¼ˆä½†ä¸æ¸…é™¤å…§å®¹ï¼‰
      const cardContainer = document.getElementById('cardContainer');
      if (cardContainer) {
        cardContainer.classList.add('hidden');
      }
    });

    tabSlot.addEventListener('click', () => {
      if (currentMode === 'slot') return;
      currentMode = 'slot';
      tabSlot.classList.add('active');
      tabPoints.classList.remove('active');
      pointsModeEl.classList.add('hidden');
      slotModeEl.classList.remove('hidden');

      // æ‹‰éœ¸æ¨¡å¼ï¼šé¡¯ç¤ºå³ä¸‹è§’æ‹‰éœ¸è¨­å®šéµ
      if (slotSettingsBtn) slotSettingsBtn.classList.remove('hidden');

      // åˆ‡å›æ‹‰éœ¸æ¨¡å¼ï¼Œå…ˆé—œé–‰è¨­å®šè¦–çª—ï¼ˆé¿å…æ®˜ç•™ï¼‰
      closeSlotSettings();

      // åˆ‡å›æ‹‰éœ¸æ¨¡å¼ï¼šè®“å¡ç‰‡å®¹å™¨å¯è¢«é¡¯ç¤ºï¼ˆå³ä½¿ç›®å‰é‚„æ²’æœ‰å¡ç‰‡ï¼‰
      const cardContainer = document.getElementById('cardContainer');
      if (cardContainer) {
        cardContainer.classList.remove('hidden');
      }
    });


    // æ®ºæ‰‹æœå°‹
    killerSearchInput.addEventListener('input', () => {
      rebuildKillerOptions(killerSearchInput.value);
    });

    // æ®ºæ‰‹é¸æ“‡
    killerSelect.addEventListener('change', () => {
      currentKillerKey = killerSelect.value || null;
      selectedAddons = [];
      selectedPerks = [];
      renderKillerInfo();
      renderSelectedAddons();
      renderSelectedPerkIcons();
      updatePointsDisplay();
      renderAddonList();
      renderPerkList();
    });

    // é…ä»¶æœå°‹ / åˆ†æ•¸éæ¿¾
    addonSearchInput.addEventListener('input', renderAddonList);
    addonScoreFilter.addEventListener('change', renderAddonList);

    // æŠ€èƒ½æœå°‹ / åˆ†æ•¸éæ¿¾
    perkSearchInput.addEventListener('input', renderPerkList);
    perkScoreFilter.addEventListener('change', renderPerkList);

    // æ¸…ç©ºç›®å‰é…ç½®
    clearBuildBtn.addEventListener('click', () => {
      selectedAddons = [];
      selectedPerks = [];
      renderSelectedAddons();
      renderSelectedPerkIcons();
      updatePointsDisplay();
      renderAddonList();
      renderPerkList();
    });

    // æ‹‰éœ¸ï¼šæŠ½ä¸€æ ¼ï¼ˆéš±è—æŒ‰éˆ•ï¼‰
    slotBtn.addEventListener('click', () => {
      drawOneSlot();
    });

    // æ‹‰éœ¸ï¼šæ‰‹å‹•é‡ç½®
    slotResetBtn.addEventListener('click', () => {
      resetSlotState();
    });

    // æ‹‰æ¡¿æ§åˆ¶
    if (leverNormalEl && leverBottomEl) {
      leverNormalEl.addEventListener('mousedown', () => {
        if (slotState.locked) return;

        if (slotState.afterFull) {
          slotState.afterFull = false;
          leverNormalEl.style.display = 'none';
          leverBottomEl.style.display = 'flex';
          resetSlotState();
          return;
        }

        leverNormalEl.style.display = 'none';
        leverBottomEl.style.display = 'flex';
        drawOneSlot();
      });

      leverBottomEl.addEventListener('mouseup', () => {
        leverBottomEl.style.display = 'none';
        leverNormalEl.style.display = 'flex';
      });

      leverBottomEl.addEventListener('mouseleave', () => {
        leverBottomEl.style.display = 'none';
        leverNormalEl.style.display = 'flex';
      });
    }

    // åˆå§‹åŒ–
    initKillerData();
    renderKillerInfo();
    renderSelectedAddons();
    renderSelectedPerkIcons();
    updatePointsDisplay();
    renderAddonList();
    renderPerkList();
    initSlotBoard();
    renderSlotBoard();
  </script>



  <!-- å¹¸é‹ç¥ç±¤ï¼šæ”¾å¤§ç¥ç±¤è¦–çª— -->
  <div id="fortuneModal"
    style="position:fixed; inset:0; background:rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index:2000;">

    <div style="
      position:relative;
      width:400px;
      height:600px;
      background:url('./images/other/ç±¤.png') center/cover no-repeat;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:32px 24px;
      box-shadow:0 12px 32px rgba(0,0,0,0.6);
      border-radius:18px;
  ">

      <!-- æŠ€èƒ½åœ–ç¤º -->
      <img id="fortuneModalPerkIcon" src="" alt="å¹¸é‹æŠ€èƒ½"
        style="width:200px; height:200px; margin-top:7px; margin-bottom:8px;">

      <!-- æ¨™é¡Œ -->
      <div id="fortuneMainTitle" style="font-size:24px; font-weight:800; margin-bottom:2px; text-align:center;">
        æœ¬å ´å¹¸é‹æŠ€èƒ½
      </div>

      <!-- æŠ€èƒ½åç¨±ï¼ˆä¸­æ–‡ + è‹±æ–‡ï¼‰ -->
      <div id="fortuneSkillName"
        style="font-size:32px; font-weight:700; margin-bottom:2px; text-align:center; white-space:pre-line; line-height:1.2;">
      </div>

      <!-- ç±¤è©©ï¼ˆç›´æ›¸ï¼‰ -->
      <div id="fortunePoem" style="
    display:flex;
    flex-direction:row;
    justify-content:center;
    align-items:flex-start;
    gap:40px;
    width:100%;
    margin-top:8px;
">

      </div>



    </div>

  </div>

  <!-- é—œé–‰ç´ -->
  <button id="fortuneModalClose" type="button" style="position:absolute; right:16px; top:16px; border:none; background:rgba(0,0,0,0.55); color:#f5f5f5;
      border-radius:999px; padding:4px 10px; font-size:12px; cursor:pointer;">âœ•</button>

  </div>
  </div>


  <script>
    (function () {
      const tube = document.getElementById('fortuneTubeBtn');
      const resultIcon = document.getElementById('fortuneResultIcon');
      const resultImg = document.getElementById('fortuneResultPerkImg');
      const modal = document.getElementById('fortuneModal');
      const modalIcon = document.getElementById('fortuneModalPerkIcon');
      const modalName = document.getElementById('fortuneModalName');
      const modalDesc = document.getElementById('fortuneModalDesc');
      const modalClose = document.getElementById('fortuneModalClose');

      if (!tube) return;

      let currentFortune = null;

      function drawFortune() {
        const perks = window.PERKS || {};
        const keys = Object.keys(perks);
        if (!keys.length) return;

        const key = keys[Math.floor(Math.random() * keys.length)];
        const perk = perks[key];

        currentFortune = { key, perk };

        if (perk && perk.img) {
          resultImg.src = perk.img;
        } else {
          resultImg.src = '';
        }

        resultIcon.style.display = 'block';
      }

      function openModal() {
        if (!currentFortune) return;
        const { key, perk } = currentFortune;


        const zh = (perk && perk.zh) ? perk.zh : '';

        const fortune = (window.pickFortune && perk)
          ? window.pickFortune(perk)
          : '';

        if (perk && perk.img) {
          modalIcon.src = perk.img;
        } else {
          modalIcon.src = '';
        }

        document.getElementById("fortuneMainTitle").textContent = "æœ¬å ´å¹¸é‹æŠ€èƒ½";

        document.getElementById("fortuneSkillName").textContent = zh || 'æœªçŸ¥æŠ€èƒ½';


        // === æ­£ç¢ºåˆ‡æˆ 5 / 7 / 5 ã€Œå¥å­ã€è€Œä¸æ˜¯ slice å­— ===
        const parts = fortune.split("ã€€"); // å…¨å½¢ç©ºæ ¼åˆ‡å¥
        const p1 = parts[0] || "";
        const p2 = parts[1] || "";
        const p3 = parts[2] || "";

        function makePoemColumn(text) {
          return `
    <div style="
      writing-mode: vertical-rl;
      text-orientation: upright;
      font-size: 28px;
      line-height: 32px;
      width: 32px;
      text-align: center;
    ">
      ${text}
    </div>
  `;
        }

        document.getElementById("fortunePoem").innerHTML = `
  ${makePoemColumn(p1)}
  ${makePoemColumn(p2)}
  ${makePoemColumn(p3)}
`;



        modal.style.display = 'flex';
      }



      function closeModal() {
        modal.style.display = 'none';
      }

      tube.addEventListener('click', drawFortune);
      resultIcon.addEventListener('click', openModal);
      modalClose.addEventListener('click', closeModal);

      modal.addEventListener('click', function (e) {
        if (e.target === modal) {
          closeModal();
        }
      });
    })();
  </script>

  <!-- Fortune System Updated -->
  <script>
    // å’Œé¢¨ 5-7-5 å¹¸é‹ç¥ç±¤æ± 
    const FORTUNE_POOL = [
      "åœ°é“ç„¡æ‰€éã€€éœ§æ·±å½±éœå¿ƒè‡ªæ˜ã€€æ‰€å°‹çš†å¯è‡³",
      "æ°£è„ˆå¿½éœ‡å‹•ã€€æ”¾æ‰‹ä¹‹æ™‚é›·è²ç ´ã€€äº‚å‹¢äº¦æˆæ©Ÿ",
      "ç®±ä¸­ç„¡å½©é‹ã€€å‘½ç†æœ¬æ·¡æ£•å½±éš¨ã€€å¹³å‡¡äº¦æˆç¦",
      "è—å½¢å¦‚è‰è˜‘ã€€éœ§å‹•é¢¨æ¯å½±è‡ªé¡¯ã€€ç„¡è™•å¯è—èº«",
      "å¿ƒå‹¢å¦‚é‹’å®šã€€æ©Ÿå…ˆä¸€æ­¥æ™ºå‹æ•µã€€ç®—ç›¡çš†æˆä½ ",
      "æ«ƒå½±é›£è—æ°£ã€€é–€æ‰‰è¼•åˆèæ°£æ¯ã€€åŒ¿è¹¤è¦‹çœŸå½¢",
      "æ¿å½±å¿½ç”Ÿè®Šã€€æƒ¡éˆæš—æ‰‹ç‰½è¡Œè·¯ã€€æœ¨å¿ƒæ‡‰é¢¨æŠ˜",
      "æ€¨æ¯çºè¶³ä¸‹ã€€å¹½æ‰‹ç‰½å½±ç¸›å¥”å‹¢ã€€æ­¥ç·©å‘½é›£è„«",
      "å¿ƒéœå¦‚æ¹–é¢ã€€ä¸äº‚ä¸æ…Œæ­¥è‡ªç©©ã€€æ‰€è¡Œçš†é †é‚",
      "é‹’æ„è‡ªç›¸æ‡‰ã€€åˆ€è¿½äººå½±ç„¡ä¸€å·®ã€€æµå…‰ç ´æš—è¡Œ",
      "éºµç·šä¸ç³¾çµã€€éŒ¯ç¶œç¨‹å¼ä»Šå¤œç©©ã€€æ•…éšœä¸ä¾†æ“¾",
      "æ°£å’Œé¢¨è‡ªé †ã€€æ•µäº¦å®ˆåˆ†é¢¨æ¸…æœ—ã€€æˆ²å±€å°‘ä¹–å¼µ",
      "éµæ„æŸ“åˆƒç«¯ã€€æ±¡æ¿äº¦èƒ½æ–¬ç™¾éšªã€€æ‰€æŒ‡çš†å‘½ä¸­"
    ];

    // æœ‰æ¢ä»¶ç±¤æ–‡ï¼ˆå„å’’ / å¤©ç½ï¼‰
    const FORTUNE_CONDITION = {
      hex: "ç¬¦ç´‹è—å’’æ¯ã€€å„å’’æ·±éš±é›£è¦“è¹¤ã€€å‘½ç†è‡ªç›¸è­·",
      scourge: "é¢¨é³´å¼•æ¥­å½±ã€€å¤©ç½é‰¤ç¾å›å´ç•”ã€€é‹å‹¢ä»Šç…§èº«"
    };

    // ä¾ç…§æŠ€èƒ½æ±ºå®šè©©ç±¤
    window.pickFortune = function (perk) {
      const als = perk.aliases || [];
      const hasHex = als.some(a => /å„å’’|hex/i.test(a));
      const hasScourge = als.some(a => /å¤©ç½|scourge/i.test(a));

      if (hasHex) return FORTUNE_CONDITION.hex;
      if (hasScourge) return FORTUNE_CONDITION.scourge;

      return FORTUNE_POOL[Math.floor(Math.random() * FORTUNE_POOL.length)];
    };
  </script>
  <!-- Dice Assets -->
  <!-- Dice (Fake 3D) -->
  <!-- Dice (Fake 3D) -->
  <div id="diceFlying" aria-hidden="true">
    <div class="dice-cube" id="diceCube">
      <div class="dice-face face-front"></div>
      <div class="dice-face face-back"></div>
      <div class="dice-face face-right"></div>
      <div class="dice-face face-left"></div>
      <div class="dice-face face-top"></div>
      <div class="dice-face face-bottom"></div>
    </div>
  </div>
  </div>
  <div id="diceModal">
    <div class="box">
      <h3>ğŸ² éª°å­çµæœ</h3>
      <div id="diceResult" style="font-size:28px;font-weight:800;margin:8px 0;">--</div>
      <button id="diceOk" type="button">ç¢ºå®š</button>
    </div>
  </div>









  <script>
    (function () {
      if (window.__DICE_TWO_SLOT_PATCH__) return;
      window.__DICE_TWO_SLOT_PATCH__ = true;

      const DICE_ICON_HTML = '<img src="./images/other/éª°å­.png" alt="dice" class="dice-icon">';

      const leftBtn = document.getElementById('diceLeftBtn');   // red slot
      const rightBtn = document.getElementById('diceRightBtn'); // yellow slot
      const dice = document.getElementById('diceFlying');
      const cube = document.getElementById('diceCube');
      const modal = document.getElementById('diceModal');
      const out = document.getElementById('diceResult');
      const ok = document.getElementById('diceOk');
      const clearBuildBtn = document.getElementById('clearBuildBtn');

      if (!leftBtn || !rightBtn || !dice || !modal || !out || !ok) return;

      function inPointsMode() {
        const points = document.getElementById('pointsMode');
        return points && !points.classList.contains('hidden');
      }

      function syncVisibility() {
        const show = inPointsMode();
        rightBtn.style.display = show ? 'flex' : 'none';
        // left is controlled by state; default hidden when entering points mode
        if (!show) leftBtn.style.display = 'none';
      }

      function randomEntry() {
        const sides = ['top', 'left', 'right'];
        return sides[Math.floor(Math.random() * sides.length)];
      }

      function setPreRollUI() {
        // initial: hide left, show right as dice
        leftBtn.style.display = 'none';

        rightBtn.classList.remove('dice-number');
        rightBtn.innerHTML = DICE_ICON_HTML;
        rightBtn.title = 'æ“²éª°(10~23)';
        rightBtn.onclick = rollDice;
      }

      function setPostRollUI(value) {
        // after roll: left shows dice for reroll
        leftBtn.style.display = 'flex';
        leftBtn.innerHTML = DICE_ICON_HTML;
        leftBtn.title = 'å†æ¬¡æ“²éª°(10~23)';
        leftBtn.onclick = rollDice;

        // right shows number; clicking number resets (clear build + clear override + back to initial)
        rightBtn.classList.add('dice-number');
        rightBtn.textContent = String(value);
        rightBtn.title = 'é»æ“Šé‡è£½ï¼ˆæ¸…ç©ºç›®å‰é…ç½®ï¼‰';
        rightBtn.onclick = () => {
          if (clearBuildBtn) clearBuildBtn.click();
          window.DICE_TOTAL_OVERRIDE = null;
          setPreRollUI();
          if (typeof updatePointsDisplay === 'function') updatePointsDisplay();
        };
      }


      /* ===== slow-stop JS controller (startRollController) ===== */
      function startRollController(diceEl) {
        let rafId = null;
        let lastT = performance.now();
        const rot = { x: 0, y: 0, z: 0 };
        // initial velocities (reduced)
        const vel = { x: 520, y: 720, z: 420 };
        let mode = "rolling";
        let target = { x: 0, y: 0, z: 0 };

        function norm(a) { a %= 360; return a < 0 ? a + 360 : a; }
        function setTransform() { diceEl.style.transform = `translateZ(-32px) rotateX(${rot.x}deg) rotateY(${rot.y}deg) rotateZ(${rot.z}deg)`; }

        function tick(t) {
          const dt = Math.min(0.05, (t - lastT) / 1000);
          lastT = t;

          if (mode === "rolling") {
            rot.x += vel.x * dt;
            rot.y += vel.y * dt;
            rot.z += vel.z * dt;
          } else {
            const dampingPerSec = 0.10;
            const damp = Math.pow(1 - dampingPerSec, dt * 60);
            vel.x *= damp; vel.y *= damp; vel.z *= damp;

            const spring = 9;
            rot.x += (target.x - rot.x) * Math.min(1, spring * dt);
            rot.y += (target.y - rot.y) * Math.min(1, spring * dt);
            rot.z += (target.z - rot.z) * Math.min(1, spring * dt);

            rot.x += vel.x * dt * 0.15;
            rot.y += vel.y * dt * 0.15;
            rot.z += vel.z * dt * 0.15;

            const speed = Math.max(Math.abs(vel.x), Math.abs(vel.y), Math.abs(vel.z));
            const diff = Math.max(Math.abs(target.x - rot.x), Math.abs(target.y - rot.y), Math.abs(target.z - rot.z));

            if (speed < 6 && diff < 1) {
              rot.x = target.x; rot.y = target.y; rot.z = target.z;
              setTransform();
              cancelAnimationFrame(rafId);
              rafId = null;
              return;
            }
          }

          rot.x = norm(rot.x); rot.y = norm(rot.y); rot.z = norm(rot.z);
          setTransform();
          rafId = requestAnimationFrame(tick);
        }

        rafId = requestAnimationFrame(tick);

        return {
          stopTo(finalRot) {
            target = { ...finalRot };
            mode = "stopping";
          },
          cancel() {
            if (rafId) cancelAnimationFrame(rafId);
            rafId = null;
          }
        };
      }
      /* ===== end controller ===== */

      function rollDice() {
        if (!inPointsMode()) return;

        // é€™å€‹éª°å­å…¶å¯¦æ˜¯ã€Œé…åˆ†ç¸½é»æ•¸ã€(7~25)ï¼Œæ‰€ä»¥å¤–è§€æ»¾å‹•åªæ˜¯è¦–è¦ºæ•ˆæœ
        const value = Math.floor(Math.random() * (25 - 7 + 1)) + 7;

        const w = window.innerWidth;
        const h = window.innerHeight;

        const cx = w / 2 - 32;
        const cy = h / 2 - 32;

        // âœ… å¾è¢å¹•å¤–ã€Œæ»¾é€²ä¾†ã€(ä¾ side æ±ºå®šå…¥å£æ–¹å‘)
        const side = randomEntry(); // 'top' | 'left' | 'right'
        const off = 140;            // è¢å¹•å¤–è·é›¢ï¼ˆè¶Šå¤§è¶Šåƒå¾å¤–é¢ä¾†ï¼‰
        const randY = () => Math.max(20, Math.min(h - 84, Math.random() * (h - 64)));
        const randX = () => Math.max(20, Math.min(w - 84, Math.random() * (w - 64)));

        let fx = cx, fy = cy;
        if (side === 'left') { fx = -off; fy = randY(); }
        if (side === 'right') { fx = w + off; fy = randY(); }
        if (side === 'top') { fx = randX(); fy = -off; }

        // âœ… è®“ rolling å‹•ç•«æ¯æ¬¡éƒ½èƒ½é‡æ–°è§¸ç™¼ï¼ˆå¼·åˆ¶ reflowï¼‰
        dice.classList.remove('rolling');
        cube.style.transition = 'none';
        cube.style.transform = 'translateZ(-32px)';
        void dice.offsetWidth; // force reflow

        dice.style.display = 'block';

        // çˆ¶å±¤åªè² è²¬ã€Œä½ç§»ã€ï¼›æ—‹è½‰äº¤çµ¦ cubeï¼ˆ3Dï¼‰
        dice.style.transform = `translate(${fx}px,${fy}px)`;

        // é–‹å§‹æ»¾å‹•: start JS rolling controller (instead of CSS infinite animation)
        // ensure any previous roller is cancelled
        if (window._diceRoller && window._diceRoller.cancel) window._diceRoller.cancel();
        // start controller on the cube element
        window._diceRoller = startRollController(cube);

        // animate parent translate to center
        requestAnimationFrame(() => {
          dice.style.transform = `translate(${cx}px,${cy}px)`;
        });

        // åˆ°ä¸­å¿ƒå¾Œï¼Œè«‹ roller æ…¢æ…¢åœåˆ°ä¸€å€‹ 90 åº¦å€æ•¸çš„å§¿å‹¢
        dice.addEventListener('transitionend', function handler(e) {
          if (e.propertyName !== 'transform') return;

          dice.removeEventListener('transitionend', handler);

          // åŸæœ¬ä½¿ç”¨ CSS infinite è½‰å‹•çš„åšæ³•å·²æ”¹ç‚º JS controller
          // è¨ˆç®—è¦åœåˆ°çš„ 90 åº¦å€æ•¸è§’åº¦
          const snap = () => (Math.floor(Math.random() * 4) * 90);
          const rx = snap(), ry = snap(), rz = snap();

          // å‘Šè¨´ roller é–‹å§‹æ…¢æ…¢åœåˆ°ç›®æ¨™è§’åº¦
          if (window._diceRoller && typeof window._diceRoller.stopTo === 'function') {
            window._diceRoller.stopTo({ x: rx, y: ry, z: rz });
          } else {
            // fallback: apply immediate transform
            cube.style.transition = 'transform 220ms ease-out';
            cube.style.transform = `translateZ(-32px) rotateX(${rx}deg) rotateY(${ry}deg) rotateZ(${rz}deg)`;
          }

          // è¨˜éŒ„çµæœ + é¡¯ç¤º modal (modal can appear while cube is slowing to stop)
          window.DICE_TOTAL_OVERRIDE = value;
          if (typeof updatePointsDisplay === 'function') updatePointsDisplay();

          out.textContent = value;
          modal.style.display = 'flex';
        }, { once: true });
      }

      ok.addEventListener('click', () => {
        modal.style.display = 'none';
        dice.style.display = 'none';
        const v = window.DICE_TOTAL_OVERRIDE;
        if (v != null) setPostRollUI(Number(v));
      });

      const tabPoints = document.getElementById('tabPoints');
      const tabSlot = document.getElementById('tabSlot');
      if (tabPoints) tabPoints.addEventListener('click', () => { syncVisibility(); if (inPointsMode()) { window.DICE_TOTAL_OVERRIDE != null ? setPostRollUI(Number(window.DICE_TOTAL_OVERRIDE)) : setPreRollUI(); } });
      if (tabSlot) tabSlot.addEventListener('click', syncVisibility);

      // initial
      syncVisibility();
      if (inPointsMode()) {
        if (window.DICE_TOTAL_OVERRIDE != null) setPostRollUI(Number(window.DICE_TOTAL_OVERRIDE));
        else setPreRollUI();
      }
    })();
  </script>


</body>

</html>