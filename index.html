<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>Dead by Daylighté…åˆ†å°éŠæˆ²</title>
  <style>
    :root {
      --bg: #05060a;
      --bg2: #101321;
      --bg3: #15192a;
      --card: #181d2e;
      --border: #2a3044;
      --accent: #3f82ff;
      --accent-soft: #7aa7ff;
      --accent-danger: #ff4b5c;
      --text: #f5f5f5;
      --muted: #a6a9c0;
      --chip-bg: rgba(255, 255, 255, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #262c45 0%, #050609 55%);
      color: var(--text);
    }

    .app {
      max-width: 1240px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 span.small {
      font-size: 14px;
      color: var(--muted);
      font-weight: 400;
    }

    .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-top: 16px;
    }

    .mode-tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.08);
      gap: 4px;
    }

    .mode-tab {
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .mode-tab.active {
      background: linear-gradient(120deg, var(--accent), var(--accent-soft));
      color: #fff;
      font-weight: 600;
    }

    .layout {
      margin-top: 18px;
    }

    .card {
      border-radius: 14px;
      background: linear-gradient(145deg, rgba(12, 15, 25, 0.98), rgba(20, 25, 38, 0.98));
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 18px 38px rgba(0, 0, 0, 0.7);
      padding: 14px;
    }

    .card+.card {
      margin-top: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 3px;
    }

    select,
    input[type="text"],
    button {
      background: #141726;
      border: 1px solid #2a3044;
      border-radius: 6px;
      color: var(--text);
      padding: 7px 9px;
      font-size: 13px;
      outline: none;
    }

    select:focus,
    input[type="text"]:focus,
    button:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(63, 130, 255, 0.5);
    }

    button {
      cursor: pointer;
    }

    button.primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-soft));
      border: none;
      color: #fff;
      font-weight: 600;
    }

    button.primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button.outline {
      background: transparent;
      border-color: rgba(255, 255, 255, 0.16);
      color: var(--muted);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .flex-1 {
      flex: 1;
      min-width: 180px;
    }

    .flex-2 {
      flex: 2;
      min-width: 260px;
    }

    .mt-8 {
      margin-top: 8px;
    }

    /* === é…åˆ†æ¨¡å¼ layout === */

    .points-layout {
      display: grid;
      grid-template-columns: 2.1fr 1.4fr;
      gap: 16px;
    }

    @media (max-width: 1040px) {
      .points-layout {
        grid-template-columns: 1fr;
      }
    }

    .list-container {
      max-height: 320px;
      overflow: auto;
      padding-right: 6px;
      margin-top: 6px;
    }

    .addon-item,
    .perk-item {
      display: grid;
      grid-template-columns: 48px 1fr auto;
      gap: 10px;
      padding: 8px 8px;
      margin-bottom: 6px;
      border-radius: 10px;
      background: rgba(11, 13, 23, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.04);
      cursor: pointer;
      transition: background 0.14s ease, border-color 0.14s ease, transform 0.06s;
    }

    .addon-item:hover,
    .perk-item:hover {
      background: rgba(21, 24, 36, 0.98);
      border-color: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    .addon-item.selected,
    .perk-item.selected {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(63, 130, 255, 0.5);
      background: radial-gradient(circle at top left, rgba(63, 130, 255, 0.25), rgba(11, 13, 23, 0.98));
    }

    .thumb {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      background: #101320;
      border: 1px solid var(--border);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--muted);
      flex-shrink: 0;
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .list-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .list-name {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .list-zh {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tags-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .tag {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 11px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: var(--muted);
    }

    .tag-score {
      border-color: rgba(255, 255, 255, 0.4);
      color: #ffe08a;
    }

    .list-right {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: space-between;
      gap: 4px;
    }

    .badge {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.35);
      font-size: 11px;
    }

    .selected-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid rgba(255, 255, 255, 0.14);
      font-size: 12px;
    }

    .selected-pill img {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      object-fit: contain;
    }

    .pill-remove {
      cursor: pointer;
      font-size: 14px;
      opacity: 0.7;
    }

    .pill-remove:hover {
      opacity: 1;
    }

    .selected-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .selected-pill {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      background: #101320;
      border: 1px solid rgba(255, 255, 255, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    .selected-pill img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }

    .pill-remove {
      position: absolute;
      top: 4px;
      right: 6px;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.8;
      color: #fff;
      text-shadow: 0 0 4px #000;
    }

    .pill-remove:hover {
      opacity: 1;
    }

    .section-note {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* === å³å´ Killer + æŠ€èƒ½åœ–ç¤º === */

    .killer-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
    }

    .build-main-layout {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      margin-top: 8px;
    }

    .kill-avatar-wrap {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .killer-avatar {
      width: 250px;
      height: 250px;
      border-radius: 12px;
      overflow: hidden;
      background: #111422;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 13px;
      flex-shrink: 0;
    }

    .killer-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .killer-name-main {
      font-size: 15px;
      font-weight: 600;
    }

    .killer-name-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .skills-row {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .skill-slot {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      background: #101320;
      border: 1px dashed rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    .skill-slot.filled {
      border-style: solid;
      border-color: rgba(255, 255, 255, 0.35);
      background: radial-gradient(circle at top, rgba(63, 130, 255, 0.35), #05060a);
    }

    .skill-slot img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      cursor: pointer;
    }

    .skill-slot span.placeholder {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      padding: 2px;
    }

    .skill-label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .build-summary {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .build-summary strong {
      color: #fff;
    }

    /* === æ‹‰éœ¸æ¨¡å¼ === */

    .slot-section {
      margin-top: 24px;
      display: flex;
      justify-content: center;
    }

    .slot-machine {
      width: 1150px;
      max-width: 100%;
      padding: 30px;
      border-radius: 26px;
      background: linear-gradient(145deg, #b49a62, #7d683e);
      border: 8px solid #5e4a28;
      box-shadow:
        inset 0 0 20px rgba(0, 0, 0, 0.6),
        0 0 18px rgba(255, 222, 150, 0.2),
        0 0 32px rgba(0, 0, 0, 0.8);
      position: relative;
    }

    .slot-machine::before {
      content: "";
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(120deg,
          rgba(255, 255, 255, 0.02) 0px,
          rgba(255, 255, 255, 0.02) 2px,
          rgba(0, 0, 0, 0.12) 5px);
      pointer-events: none;
    }

    .slot-machine.glow {
      box-shadow:
        inset 0 0 20px rgba(0, 0, 0, 0.6),
        0 0 30px rgba(255, 240, 200, 0.7),
        0 0 60px rgba(255, 240, 200, 0.95);
      animation: slotMachineGlow 1.3s ease-in-out infinite alternate;
    }

    @keyframes slotMachineGlow {
      0% {
        transform: scale(1);
        filter: brightness(1);
      }

      100% {
        transform: scale(1.01);
        filter: brightness(1.08);
      }
    }

    #cardContainer {
      width: 100%;
      max-width: 1150px;
      margin: 8px auto 0;
      display: flex;
      justify-content: center;
      gap: 12px;
      opacity: 0;
      transform: translateY(16px);
      pointer-events: none;
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
    }

    #cardContainer.card-visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .slot-header {
      margin-bottom: 10px;
    }

    .slot-title-main {
      font-size: 18px;
      font-weight: 600;
    }

    .slot-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .slot-inner {
      margin-top: 8px;
      background: #1a1a1a;
      border-radius: 16px;
      border: 5px solid #8f6e3c;
      padding: 24px 18px 28px;
      box-shadow:
        inset 0 0 15px rgba(0, 0, 0, 0.7),
        0 0 10px rgba(255, 210, 140, 0.25);
      display: flex;
      justify-content: center;
      position: relative;
    }

    .slot-board-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .slot-board {
      display: grid;
      grid-template-columns: repeat(7, 120px);
      gap: 12px;
      justify-content: center;
    }

    .slot-cell {
      width: 120px;
      min-height: 160px;
      border-radius: 14px;
      background: #101320;
      border: 1px solid var(--border);
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
      box-shadow:
        inset 0 0 12px rgba(0, 0, 0, 0.7),
        0 0 8px rgba(0, 0, 0, 0.8);
    }


    .slot-anim-out {
      animation: slotFadeOutUp 0.3s ease forwards;
    }

    .slot-anim-in {
      animation: slotFadeInUp 0.3s ease forwards;
    }

    @keyframes slotFadeOutUp {
      0% {
        opacity: 1;
        transform: translateY(0);
      }

      100% {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    @keyframes slotFadeInUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slot-cell-label {
      font-size: 11px;
      color: var(--muted);
    }

    .slot-icon {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      background: #05060a;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--muted);
      padding: 4px;
    }

    .slot-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .slot-name {
      font-size: 11px;
      text-align: center;
      color: #ddd;
      padding: 0 2px;
    }

    .lever-normal,
    .lever-bottom {
      position: absolute;
      right: -80px;
      top: 50%;
      transform: translateY(-50%);
      width: 120px;
      height: 260px;
      display: flex;
      justify-content: center;
      align-items: flex-end;
    }

    .lever-bottom {
      display: none;
    }

    .lever-stick {
      width: 22px;
      height: 150px;
      background: linear-gradient(180deg, #a98a4a, #6e5a33);
      border-radius: 12px;
      position: relative;
      box-shadow:
        inset 0 0 10px rgba(0, 0, 0, 0.6),
        0 10px 14px rgba(0, 0, 0, 0.6);
    }

    .lever-ball,
    .bottom-ball {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ff5a5a, #7a0000);
      box-shadow:
        inset 0 0 16px rgba(255, 255, 255, 0.3),
        0 0 14px rgba(0, 0, 0, 0.8);
    }

    .lever-ball {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
    }

    .bottom-ball {
      margin-bottom: 5px;
    }

    .slot-hint {
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .slot-board.win-anim {
      animation: slotGlow 0.8s ease-in-out 3;
    }

    @keyframes slotGlow {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
        transform: scale(1);
      }

      50% {
        box-shadow: 0 0 32px 4px rgba(255, 215, 128, 0.7);
        transform: scale(1.01);
      }
    }

    .slot-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      font-size: 18px;
      color: #ffe8a0;
      text-shadow: 0 0 12px rgba(0, 0, 0, 0.8);
    }

    .hidden {
      display: none !important;
    }

    /* --- å³ä¸Šè§’å•è™ŸæŒ‰éˆ• --- */
    #help-btn {
      position: fixed;
      top: 22px;
      right: 28px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 1.8px solid rgba(255, 255, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: #fff;
      cursor: pointer;
      backdrop-filter: blur(6px);
      background: rgba(0, 0, 0, 0.35);
      z-index: 9999;
      transition: 0.15s ease;
    }

    #help-btn:hover {
      transform: scale(1.08);
      border-color: #3f82ff;
    }

    /* --- Modal èƒŒæ™¯ --- */
    #help-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }

    /* --- Modal å…§å®¹æ¡† --- */
    .help-content {
      width: 420px;
      max-height: 78vh;
      background: #121622;
      border-radius: 14px;
      border: 1px solid #2a3044;
      padding: 18px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
      overflow-y: auto;
    }

    /* --- Header --- */
    .help-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 18px;
      font-weight: 600;
    }

    #help-close {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
    }

    /* --- èªªæ˜æ–‡æœ¬ --- */
    .help-text {
      font-size: 14px;
      line-height: 1.6em;
      color: #d3d6e4;
      white-space: pre-line;
    }
  </style>
</head>

<body>
  <div class="app">
    <h1>
      DBD æ®ºæ‰‹é…é» & æ‹‰éœ¸å·¥å…·
      <span class="small">ï¼ˆé…åˆ†æ¨¡å¼ + æ‹‰éœ¸æ¨¡å¼ï¼‰</span>
    </h1>

    <div class="top-row">
      <div class="mode-tabs">
        <button id="tabPoints" class="mode-tab active" type="button">é…åˆ†æ¨¡å¼</button>
        <button id="tabSlot" class="mode-tab" type="button">æ‹‰éœ¸æ¨¡å¼</button>
      </div>
    </div>

    <!-- === é…åˆ†æ¨¡å¼ === -->
    <div id="pointsMode" class="layout">
      <div class="points-layout">
        <!-- å·¦å´ï¼šæ®ºæ‰‹é¸æ“‡ + é…ä»¶ & æŠ€èƒ½åˆ—è¡¨ -->
        <div>
          <!-- æ®ºæ‰‹é¸æ“‡å€ -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">æ®ºæ‰‹é¸æ“‡</div>
                <div class="card-sub">å¯ä»¥ç”¨æœå°‹ï¼ˆä¸­ / è‹± / åˆ¥åï¼‰å¿«é€Ÿæ‰¾åˆ°è¦çš„æ®ºæ‰‹</div>
              </div>
            </div>
            <div class="row">
              <div class="flex-2">
                <div class="label">æœå°‹æ®ºæ‰‹</div>
                <input id="killerSearch" type="text" placeholder="ä¾‹ï¼šå¨å»‰ã€å‡œå¦¹ã€é–ƒé›»å¤§å¸¥å“¥â€¦" />
              </div>
              <div class="flex-1">
                <div class="label">é¸æ“‡æ®ºæ‰‹</div>
                <select id="killerSelect">
                  <option value="">è«‹é¸æ“‡æ®ºæ‰‹â€¦</option>
                </select>
              </div>
            </div>
          </div>

          <!-- é…ä»¶åˆ—è¡¨ -->
          <div class="card mt-8">
            <div class="card-header">
              <div>
                <div class="card-title">é…ä»¶åˆ—è¡¨</div>
                <div id="addonSubTitle" class="card-sub"></div>
              </div>
            </div>

            <div class="row">
              <div class="flex-2">
                <div class="label">é…ä»¶æœå°‹ï¼ˆä¸­ / è‹± / åˆ¥åï¼‰</div>
                <input id="addonSearch" type="text" placeholder="ä¾‹ï¼šè¿·å› é…ä»¶ã€é¤…ä¹¾å¤¾ã€æ°¸ä¸€â€¦" />
              </div>
              <div style="width: 150px; margin-left: auto;">
                <div class="label">åˆ†æ•¸éæ¿¾</div>
                <select id="addonScoreFilter">
                  <option value="">å…¨éƒ¨</option>
                  <option value="0"> 0 åˆ†</option>
                  <option value="1"> 1 åˆ†</option>
                  <option value="2"> 2 åˆ†</option>
                  <option value="3"> 3 åˆ†</option>
                  <option value="4"> 4 åˆ†</option>
                  <option value="5"> 5 åˆ†</option>
                </select>
              </div>
            </div>

            <div id="addonList" class="list-container"></div>

            <div class="section-note">é»æ“Šé…ä»¶å¡ç‰‡å³å¯åŠ å…¥ / ç§»é™¤ã€‚</div>
          </div>

          <!-- æŠ€èƒ½åˆ—è¡¨ -->
          <div class="card mt-8">
            <div class="card-header">
              <div>
                <div class="card-title">æŠ€èƒ½åˆ—è¡¨ï¼ˆPerksï¼‰</div>
                <div id="perkSubTitle" class="card-sub">å¾å…¨æ± ä¸­æŒ‘ 4 å€‹æŠ€èƒ½</div>
              </div>
            </div>

            <div class="row">
              <div class="flex-2">
                <div class="label">æŠ€èƒ½æœå°‹ï¼ˆä¸­ / è‹± / åˆ¥åï¼‰</div>
                <input id="perkSearch" type="text" placeholder="ä¾‹ï¼šè²å­çœ¼ã€è¶…é•·åˆ€ã€å¤©ç½é‰¤â€¦" />
              </div>
              <div style="width: 150px; margin-left: auto;">
                <div class="label">åˆ†æ•¸éæ¿¾</div>
                <select id="perkScoreFilter">
                  <option value="">å…¨éƒ¨</option>
                  <option value="0"> 0 åˆ†</option>
                  <option value="1"> 1 åˆ†</option>
                  <option value="2"> 2 åˆ†</option>
                  <option value="3"> 3 åˆ†</option>
                  <option value="4"> 4 åˆ†</option>
                  <option value="5"> 5 åˆ†</option>
                </select>
              </div>
            </div>

            <div id="perkList" class="list-container"></div>

            <div class="section-note">é»æ“ŠæŠ€èƒ½å¡ç‰‡å³å¯åŠ å…¥ / ç§»é™¤ã€‚</div>
          </div>
        </div>

        <!-- å³å´ï¼šç›®å‰é…ç½® -->
        <div>
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">ç›®å‰é…ç½®</div>
                <div class="card-sub">é¡¯ç¤ºç•¶å‰æ®ºæ‰‹ã€é…ä»¶èˆ‡æŠ€èƒ½ï¼ˆå³å´æŠ€èƒ½ç‚º 4 æ ¼åœ–ç¤ºï¼‰</div>
              </div>
              <button id="clearBuildBtn" type="button" class="outline">æ¸…ç©ºç›®å‰é…ç½®</button>
            </div>

            <!-- æ®ºæ‰‹ + é…ä»¶ ç‰ˆé¢ -->
            <div class="build-main-layout">
              <div class="kill-avatar-wrap">
                <div class="killer-box">
                  <div id="killerAvatar" class="killer-avatar">
                    å°šæœªé¸æ“‡
                  </div>
                  <div>
                    <div id="killerName" class="killer-name-main">â€”</div>
                    <div id="killerZh" class="killer-name-sub">è«‹å…ˆé¸æ“‡æ®ºæ‰‹</div>
                  </div>
                </div>
              </div>
              <div>
                <div class="label">å·²é¸é…ä»¶</div>
                <div id="selectedAddons" class="selected-grid"></div>
              </div>
            </div>

            <!-- æŠ€èƒ½ 4 æ ¼åœ–ç¤º -->
            <div class="mt-8">
              <div class="label">æŠ€èƒ½æ¬„ä½</div>
              <div class="skills-row" id="selectedPerkIcons">
                <!-- 4 å€‹ slot æœƒå‹•æ…‹å¡« -->
              </div>
            </div>

            <!-- ç¸½çµæ–‡å­— -->
            <div id="buildSummary" class="build-summary mt-8"></div>

            <!-- ç›®å‰åˆ†æ•¸å¡ç‰‡ -->
            <!-- â­ ç¨ç«‹çš„ç›®å‰é…åˆ†å¡ç‰‡ -->
            <div id="currentPointsCard" class="card mt-8">
              <div class="card-title" style="font-size:15px; font-weight:600;">ç›®å‰é…åˆ†</div>
              <div style="font-size:12px; color:#a6a9c0; margin-top:2px;">
                A = B - ( C + D )
              </div>

              <!-- å››å€‹å¤§æ•¸å­— -->
              <div style="display:flex; gap:32px; margin-top:10px; align-items:flex-end;">
                <div style="text-align:center;">
                  <div id="cp_A" style="font-size:28px; font-weight:700;">â€”</div>
                  <div style="font-size:12px; color:#a6a9c0;">å‰©é¤˜åˆ†æ•¸</div>
                </div>

                <div style="text-align:center;">
                  <div id="cp_B" style="font-size:22px; font-weight:600;">â€”</div>
                  <div style="font-size:12px; color:#a6a9c0;">æ®ºæ‰‹ä¸Šé™</div>
                </div>

                <div style="text-align:center;">
                  <div id="cp_C" style="font-size:22px; font-weight:600;">â€”</div>
                  <div style="font-size:12px; color:#a6a9c0;">é…ä»¶ç¸½åˆ†</div>
                </div>

                <div style="text-align:center;">
                  <div id="cp_D" style="font-size:22px; font-weight:600;">â€”</div>
                  <div style="font-size:12px; color:#a6a9c0;">æŠ€èƒ½ç¸½åˆ†</div>
                </div>
              </div>
            </div>

            <!-- å¹¸é‹ç¥ç±¤ï¼šé…åˆ†æ¨¡å¼åº•éƒ¨ -->
            <div id="fortuneRow"
              style="margin-top:16px; display:flex; align-items:center; gap:16px; justify-content:flex-end;">
              <img id="fortuneTubeBtn" src="./images/other/ç±¤ç­’.png" alt="æŠ½ç¥ç±¤"
                style="width:56px; height:56px; cursor:pointer; filter: drop-shadow(0 0 6px rgba(0,0,0,0.7));">
              <div id="fortuneResultIcon"
                style="width:56px; height:56px; border-radius:12px; border:1px solid rgba(255,255,255,0.25); background:#111320; display:none; cursor:pointer; overflow:hidden;">
                <img id="fortuneResultPerkImg" src="" alt="å¹¸é‹æŠ€èƒ½" style="width:100%; height:100%; object-fit:contain;">
              </div>
            </div>


          </div>
        </div>
      </div>
    </div>

    <!-- === æ‹‰éœ¸æ¨¡å¼ === -->
    <div id="slotMode" class="slot-section hidden">
      <div class="slot-machine">
        <div class="slot-header">
          <div class="slot-title-main">æ‹‰éœ¸æ¨¡å¼</div>
          <div class="slot-sub">æ‹‰ä¸‹æ‹‰æ¡¿å°±å¥½äº†å–”</div>
        </div>

        <div class="slot-inner">
          <div class="slot-board-wrapper">
            <div class="slot-board" id="slotBoard">
              <!-- 7 æ ¼ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
            </div>
          </div>

          <!-- æ‹‰æ¡¿ï¼šæ­£å¸¸ç‹€æ…‹ï¼ˆä¸Šæ–¹ç´…çƒ + æ¡¿å­ï¼‰ -->
          <div id="leverNormal" class="lever-normal">
            <div class="lever-stick">
              <div class="lever-ball"></div>
            </div>
          </div>

          <!-- æ‹‰æ¡¿ï¼šæ‹‰åˆ°åº•æ™‚åªé¡¯ç¤ºåº•éƒ¨ç´…çƒ -->
          <div id="leverBottom" class="lever-bottom">
            <div class="bottom-ball"></div>
          </div>

          <!-- å®Œæˆè¦†è“‹è¨Šæ¯ï¼ˆæŠ½æ»¿ 7 æ ¼æ™‚é¡¯ç¤ºï¼‰ -->
          <div id="slotOverlay" class="slot-overlay hidden" style="display:none;">
            ğŸ‰ å®Œæˆï¼ï¼ˆ3 ç§’å¾Œè‡ªå‹•é‡ç½®ï¼‰
          </div>
        </div>

        <!-- èˆŠçš„æŒ‰éˆ•æ”¹ç‚ºéš±è—ï¼Œåªçµ¦ JS ä½¿ç”¨ -->
        <button id="slotBtn" type="button" class="hidden">ğŸ° æŠ½ä¸€æ ¼</button>
        <button id="slotResetBtn" type="button" class="hidden">é‡ç½®æ‹‰éœ¸</button>

        <div class="slot-hint"></div>
      </div>
    </div>
  </div>

  <!-- è³‡æ–™æª” -->
  <script src="killers.js"></script>
  <script src="addons.js"></script>
  <script src="perks.js"></script>
  <script src="card.js"></script>

  <script>
    // ========================================
    //(ï¾‰>Ï‰<)ï¾‰ âœ§        Ado          âœ§ãƒ½(>Ï‰<ãƒ½)
    //(ï¾‰>Ï‰<)ï¾‰ âœ§     è¶…ã‹ã‚ã„ã„ï¼     âœ§ãƒ½(>Ï‰<ãƒ½)
    //(ï¾‰>Ï‰<)ï¾‰ âœ§        Ado          âœ§ãƒ½(>Ï‰<ãƒ½)
    //(ï¾‰>Ï‰<)ï¾‰ âœ§    è¶…ã‹ã£ã“ã„ã„ï¼    âœ§ãƒ½(>Ï‰<ãƒ½)
    // ========================================

    // ==========================
    // å…¨åŸŸç‹€æ…‹ & DOM åƒç…§
    // ==========================
    const killerSelect = document.getElementById('killerSelect');
    const killerSearchInput = document.getElementById('killerSearch');

    const addonSearchInput = document.getElementById('addonSearch');
    const addonScoreFilter = document.getElementById('addonScoreFilter');
    const addonListEl = document.getElementById('addonList');
    const addonSubTitle = document.getElementById('addonSubTitle');

    const perkSearchInput = document.getElementById('perkSearch');
    const perkScoreFilter = document.getElementById('perkScoreFilter');
    const perkListEl = document.getElementById('perkList');
    const perkSubTitle = document.getElementById('perkSubTitle');

    const killerAvatarEl = document.getElementById('killerAvatar');
    const killerNameEl = document.getElementById('killerName');
    const killerZhEl = document.getElementById('killerZh');

    const selectedAddonsEl = document.getElementById('selectedAddons');
    const selectedPerkIconsEl = document.getElementById('selectedPerkIcons');
    const buildSummaryEl = document.getElementById('buildSummary');

    const currentPointsValueEl = document.getElementById('currentPointsValue');
    const currentPointsNoteEl = document.getElementById('currentPointsNote');

    const tabPoints = document.getElementById('tabPoints');
    const tabSlot = document.getElementById('tabSlot');
    const pointsModeEl = document.getElementById('pointsMode');
    const slotModeEl = document.getElementById('slotMode');

    const clearBuildBtn = document.getElementById('clearBuildBtn');

    const slotBoardEl = document.getElementById('slotBoard');
    const slotBtn = document.getElementById('slotBtn');
    const slotResetBtn = document.getElementById('slotResetBtn');
    const slotOverlayEl = document.getElementById('slotOverlay');
    const leverNormalEl = document.getElementById('leverNormal');
    const leverBottomEl = document.getElementById('leverBottom');

    let currentMode = 'points';
    let currentKillerKey = null;

    // é…åˆ†æ¨¡å¼é¸ä¸­çš„é…ä»¶ / æŠ€èƒ½
    let selectedAddons = []; // array of addon name
    let selectedPerks = [];  // array of perk name

    // æ®ºæ‰‹åŸå§‹åˆ—è¡¨ï¼ˆç”¨æ–¼æœå°‹ï¼‰
    let allKillerEntries = [];

    // æ‹‰éœ¸æ¨¡å¼ç‹€æ…‹
    const slotState = {
      killerKey: null,
      addons: [], // 2
      perks: [],  // 4
      locked: false,
      animTimeout: null,
      afterFull: false,
    };

    // ==========================
    // åˆå§‹åŒ–æ®ºæ‰‹ä¸‹æ‹‰ + æœå°‹
    // ==========================
    function initKillerData() {
      if (!window.KILLERS) {
        console.error('KILLERS æœªå®šç¾©ï¼Œè«‹ç¢ºèª killers.js å·²è¼‰å…¥');
        return;
      }
      allKillerEntries = Object.entries(KILLERS).map(([key, killer]) => ({ key, killer }));
      rebuildKillerOptions('');
    }

    function rebuildKillerOptions(term) {
      const lower = (term || '').trim().toLowerCase();
      killerSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ®ºæ‰‹â€¦</option>';

      for (const { key, killer } of allKillerEntries) {
        if (lower) {
          const haystack = [
            key,
            killer.zh || '',
            ...(killer.aliases || [])
          ].join(' ').toLowerCase();
          if (!haystack.includes(lower)) continue;
        }
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = killer.zh ? `${killer.zh} / ${key}` : key;
        killerSelect.appendChild(opt);
      }

      if (currentKillerKey && Array.from(killerSelect.options).some(o => o.value === currentKillerKey)) {
        killerSelect.value = currentKillerKey;
      } else if (!currentKillerKey) {
        killerSelect.value = '';
      }
    }

    // ==========================
    // è¨ˆç®— / é¡¯ç¤ºé…åˆ†
    // ==========================
    function computePoints() {
      if (!currentKillerKey || !window.KILLERS) return { limit: 0, usedAddons: 0, usedPerks: 0 };

      const killer = KILLERS[currentKillerKey] || {};
      const limit = Number(killer.limit ?? 0);

      let usedAddons = 0;
      for (const name of selectedAddons) {
        const addon = ADDONS?.[name];
        if (!addon) continue;
        usedAddons += Number(addon.score ?? 0);
      }

      let usedPerks = 0;
      for (const name of selectedPerks) {
        const perk = PERKS?.[name];
        if (!perk) continue;
        usedPerks += Number(perk.score ?? 0);
      }

      return { limit, usedAddons, usedPerks };
    }

    // åªè² è²¬æ›´æ–°ã€Œç›®å‰åˆ†æ•¸ã€å¡ç‰‡
    function updatePointsDisplay() {
      const A = document.getElementById("cp_A");
      const B = document.getElementById("cp_B");
      const C = document.getElementById("cp_C");
      const D = document.getElementById("cp_D");

      if (!currentKillerKey) {
        A.textContent = B.textContent = C.textContent = D.textContent = "â€”";
        A.style.color = "#ffffff";
        return;
      }

      const { limit, usedAddons, usedPerks } = computePoints();

      // ä¾ç…§åœ–ç‰‡å…¬å¼ï¼šA = B - (C + D)
      const remaining = limit - (usedAddons + usedPerks);

      // å››é …å¤§æ•¸å­—
      A.textContent = remaining;
      B.textContent = limit;
      C.textContent = usedAddons;
      D.textContent = usedPerks;

      // é¡è‰²ï¼ˆåªå½±éŸ¿ Aï¼‰
      if (remaining > 0) {
        A.style.color = "#7CFF8A"; // ç¶ è‰²
      } else if (remaining === 0) {
        A.style.color = "#FFFFFF"; // ç™½è‰²
      } else {
        A.style.color = "#FF4B5C"; // ç´…è‰²
      }
    }


    // ==========================
    // æ¸²æŸ“å³å´ï¼šæ®ºæ‰‹ã€é…ä»¶ã€æŠ€èƒ½åœ–ç¤º
    // ==========================
    function renderKillerInfo() {
      if (!currentKillerKey || !window.KILLERS) {
        killerAvatarEl.innerHTML = 'å°šæœªé¸æ“‡';
        killerNameEl.textContent = 'â€”';
        killerZhEl.textContent = 'è«‹å…ˆé¸æ“‡æ®ºæ‰‹';
        return;
      }
      const killer = KILLERS[currentKillerKey];
      killerAvatarEl.innerHTML = '';
      if (killer.img) {
        const img = document.createElement('img');
        img.src = killer.img;
        img.alt = currentKillerKey;
        killerAvatarEl.appendChild(img);
      } else {
        killerAvatarEl.textContent = 'No Img';
      }
      killerNameEl.textContent = currentKillerKey;
      killerZhEl.textContent = killer.zh || 'ï¼ˆç„¡ä¸­æ–‡åç¨±ï¼‰';
    }

    function renderSelectedAddons() {
      selectedAddonsEl.innerHTML = '';
      if (!selectedAddons.length) {
        const span = document.createElement('span');
        span.style.color = 'var(--muted)';
        span.textContent = 'å°šæœªé¸æ“‡é…ä»¶';
        selectedAddonsEl.appendChild(span);
        return;
      }
      for (const name of selectedAddons) {
        const addon = ADDONS?.[name];
        if (!addon) continue;

        const pill = document.createElement('div');
        pill.className = 'selected-pill';

        if (addon.img) {
          const img = document.createElement('img');
          img.src = addon.img;
          img.alt = name;
          pill.appendChild(img);
        }

        const remove = document.createElement('span');
        remove.className = 'pill-remove';
        remove.textContent = 'Ã—';
        remove.title = 'ç§»é™¤æ­¤é…ä»¶';
        remove.onclick = () => {
          selectedAddons = selectedAddons.filter(n => n !== name);
          renderSelectedAddons();
          renderSelectedPerkIcons();
          updatePointsDisplay();
          renderAddonList();
        };
        pill.appendChild(remove);

        selectedAddonsEl.appendChild(pill);
      }
    }

    function renderSelectedPerkIcons() {
      selectedPerkIconsEl.innerHTML = '';
      for (let i = 0; i < 4; i++) {
        const slot = document.createElement('div');
        slot.className = 'skill-slot';

        const perkName = selectedPerks[i];
        if (!perkName) {
          const span = document.createElement('span');
          span.className = 'placeholder';
          span.textContent = 'ç©º';
          slot.appendChild(span);
        } else {
          const perk = PERKS?.[perkName];
          slot.classList.add('filled');
          if (perk && perk.img) {
            const img = document.createElement('img');
            img.src = perk.img;
            img.alt = perkName;
            const zh = perk.zh || '';
            const score = perk.score ?? 0;
            img.title = `${perkName}${zh ? ' / ' + zh : ''}ï¼ˆ${score} åˆ†ï¼‰\né»æ“Šç§»é™¤`;
            img.onclick = () => {
              selectedPerks = selectedPerks.filter(n => n !== perkName);
              renderSelectedPerkIcons();
              renderSelectedAddons();
              updatePointsDisplay();
              renderPerkList();
            };
            slot.appendChild(img);
          } else {
            const span = document.createElement('span');
            span.className = 'placeholder';
            span.textContent = perkName;
            slot.appendChild(span);
          }
        }
        selectedPerkIconsEl.appendChild(slot);
      }

      const { limit, usedAddons, usedPerks } = computePoints();
      if (!currentKillerKey) {
        buildSummaryEl.textContent = '';
        return;
      }
      const totalUsed = usedAddons + usedPerks;
      const remaining = limit - totalUsed;

      
      const addonNames = selectedAddons
        .map(a => {
          const data = ADDONS[a];
          const zh = data?.zh ? ` / ${data.zh}` : "";
          return `${a}${zh}`;
        })
        .join("ã€");

      const addonNamesZh = selectedAddons
        .map(a => {
          const key = a.key || a;
          return window.ADDONS[key]?.zh || "";
        })
        .filter(n => n !== "")
        .join("ã€");

      const perkNamesZh = selectedPerks
        .map(p => {
          const key = p.key || p;
          return window.PERKS[key]?.zh || "";
        })
        .filter(n => n !== "")
        .join("ã€");

      buildSummaryEl.innerHTML = `
      <div style="line-height:1.8; font-size:14px;">
        <div><strong>é…ä»¶ï¼š</strong>${addonNamesZh || "â€”"}</div>
        <div><strong>æŠ€èƒ½ï¼š</strong>${perkNamesZh || "â€”"}</div>
      </div>
    `;
    }



    // ==========================
    // é…ä»¶ / æŠ€èƒ½åˆ—è¡¨ï¼ˆå·¦å´ï¼‰
    // ==========================
    function getFilteredAddons() {
      if (!currentKillerKey || !window.ADDONS) return [];
      const term = (addonSearchInput.value || '').trim().toLowerCase();
      const scoreFilterValue = addonScoreFilter.value;
      const exactScore = scoreFilterValue === '' ? null : Number(scoreFilterValue);

      const result = [];
      for (const [name, addon] of Object.entries(ADDONS)) {
        if (addon.killer !== currentKillerKey) continue;

        const score = Number(addon.score ?? 0);
        if (exactScore !== null && score !== exactScore) continue;

        if (term) {
          const zh = (addon.zh || '').toLowerCase();
          const aliases = (addon.aliases || []).join(' ').toLowerCase();
          const combined = `${name.toLowerCase()} ${zh} ${aliases}`;
          if (!combined.includes(term)) continue;
        }
        result.push([name, addon]);
      }

      result.sort((a, b) => {
        const sA = Number(a[1].score ?? 0);
        const sB = Number(b[1].score ?? 0);
        if (sA !== sB) return sA - sB;
        return a[0].localeCompare(b[0]);
      });

      return result;
    }

    function renderAddonList() {
      addonListEl.innerHTML = '';
      if (!currentKillerKey) {
        addonSubTitle.textContent = 'è«‹å…ˆé¸æ“‡æ®ºæ‰‹';
        return;
      }
      const list = getFilteredAddons();
      const total = Object.values(ADDONS || {}).filter(a => a.killer === currentKillerKey).length;
      addonSubTitle.textContent = `é¡¯ç¤º ${list.length} / ${total} å€‹é…ä»¶`;

      if (!list.length) {
        const div = document.createElement('div');
        div.style.color = 'var(--muted)';
        div.style.fontSize = '13px';
        div.textContent = 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é…ä»¶ã€‚';
        addonListEl.appendChild(div);
        return;
      }

      for (const [name, addon] of list) {
        const item = document.createElement('div');
        const isSelected = selectedAddons.includes(name);
        item.className = 'addon-item' + (isSelected ? ' selected' : '');

        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        if (addon.img) {
          const img = document.createElement('img');
          img.src = addon.img;
          img.alt = name;
          thumb.appendChild(img);
        } else {
          thumb.textContent = 'No Img';
        }

        const main = document.createElement('div');
        main.className = 'list-main';
        const title = document.createElement('div');
        title.className = 'list-name';
        title.textContent = name;
        const zh = document.createElement('div');
        zh.className = 'list-zh';
        zh.textContent = addon.zh || 'ï¼ˆç„¡ä¸­æ–‡åç¨±ï¼‰';

        main.appendChild(title);
        main.appendChild(zh);

        const tags = document.createElement('div');
        tags.className = 'tags-row';

        const scoreTag = document.createElement('span');
        scoreTag.className = 'tag tag-score';
        scoreTag.textContent = `åˆ†æ•¸ï¼š${addon.score ?? 0}`;
        tags.appendChild(scoreTag);

        const killerTag = document.createElement('span');
        killerTag.className = 'tag';
        const killer = KILLERS[addon.killer];
        killerTag.textContent = killer?.zh ? `${killer.zh} / ${addon.killer}` : addon.killer;
        tags.appendChild(killerTag);

        main.appendChild(tags);

        const right = document.createElement('div');
        right.className = 'list-right';
        const hint = document.createElement('div');
        hint.textContent = isSelected ? 'å·²åŠ å…¥' : 'é»æ“ŠåŠ å…¥';
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = isSelected ? 'é¸ä¸­' : 'æœªé¸ä¸­';
        right.appendChild(hint);
        right.appendChild(badge);

        item.appendChild(thumb);
        item.appendChild(main);
        item.appendChild(right);

        item.onclick = () => {
          if (isSelected) {
            selectedAddons = selectedAddons.filter(n => n !== name);
          } else {
            if (selectedAddons.length >= 2) {
              alert('é…ä»¶æœ€å¤šåªèƒ½é¸ 2 å€‹ã€‚');
              return;
            }
            selectedAddons.push(name);
          }
          renderSelectedAddons();
          renderSelectedPerkIcons();
          updatePointsDisplay();
          renderAddonList();
        };

        addonListEl.appendChild(item);
      }
    }

    function getFilteredPerks() {
      if (!window.PERKS) return [];
      const term = (perkSearchInput.value || '').trim().toLowerCase();
      const scoreFilterValue = perkScoreFilter.value;
      const exactScore = scoreFilterValue === '' ? null : Number(scoreFilterValue);

      const result = [];
      for (const [name, perk] of Object.entries(PERKS)) {
        const score = Number(perk.score ?? 0);
        if (exactScore !== null && score !== exactScore) continue;

        if (term) {
          const zh = (perk.zh || '').toLowerCase();
          const aliases = (perk.aliases || []).join(' ').toLowerCase();
          const combined = `${name.toLowerCase()} ${zh} ${aliases}`;
          if (!combined.includes(term)) continue;
        }
        result.push([name, perk]);
      }

      result.sort((a, b) => {
        const sA = Number(a[1].score ?? 0);
        const sB = Number(b[1].score ?? 0);
        if (sA !== sB) return sA - sB;
        return a[0].localeCompare(b[0]);
      });

      return result;
    }

    function renderPerkList() {
      perkListEl.innerHTML = '';
      const list = getFilteredPerks();
      perkSubTitle.textContent = `é¡¯ç¤º ${list.length} å€‹æŠ€èƒ½`;

      if (!list.length) {
        const div = document.createElement('div');
        div.style.color = 'var(--muted)';
        div.style.fontSize = '13px';
        div.textContent = 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æŠ€èƒ½ã€‚';
        perkListEl.appendChild(div);
        return;
      }

      for (const [name, perk] of list) {
        const item = document.createElement('div');
        const isSelected = selectedPerks.includes(name);
        item.className = 'perk-item' + (isSelected ? ' selected' : '');

        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        if (perk.img) {
          const img = document.createElement('img');
          img.src = perk.img;
          img.alt = name;
          thumb.appendChild(img);
        } else {
          thumb.textContent = 'No Img';
        }

        const main = document.createElement('div');
        main.className = 'list-main';
        const title = document.createElement('div');
        title.className = 'list-name';
        title.textContent = name;
        const zh = document.createElement('div');
        zh.className = 'list-zh';
        zh.textContent = perk.zh || 'ï¼ˆç„¡ä¸­æ–‡åç¨±ï¼‰';

        main.appendChild(title);
        main.appendChild(zh);

        const tags = document.createElement('div');
        tags.className = 'tags-row';

        const scoreTag = document.createElement('span');
        scoreTag.className = 'tag tag-score';
        scoreTag.textContent = `åˆ†æ•¸ï¼š${perk.score ?? 0}`;
        tags.appendChild(scoreTag);

        main.appendChild(tags);

        const right = document.createElement('div');
        right.className = 'list-right';
        const hint = document.createElement('div');
        hint.textContent = isSelected ? 'å·²åŠ å…¥' : 'é»æ“ŠåŠ å…¥';
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = isSelected ? 'é¸ä¸­' : 'æœªé¸ä¸­';
        right.appendChild(hint);
        right.appendChild(badge);

        item.appendChild(thumb);
        item.appendChild(main);
        item.appendChild(right);

        item.onclick = () => {
          if (isSelected) {
            selectedPerks = selectedPerks.filter(n => n !== name);
          } else {
            if (selectedPerks.length >= 4) {
              alert('æŠ€èƒ½æœ€å¤šåªèƒ½é¸ 4 å€‹ã€‚');
              return;
            }
            selectedPerks.push(name);
          }
          renderSelectedPerkIcons();
          renderSelectedAddons();
          updatePointsDisplay();
          renderPerkList();
        };

        perkListEl.appendChild(item);
      }
    }

    // ==========================
    // æ‹‰éœ¸æ¨¡å¼
    // ==========================
    function initSlotBoard() {
      slotBoardEl.innerHTML = '';

      const labels = [
        'æ®ºæ‰‹',
        'é…ä»¶ 1',
        'é…ä»¶ 2',
        'æŠ€èƒ½ 1',
        'æŠ€èƒ½ 2',
        'æŠ€èƒ½ 3',
        'æŠ€èƒ½ 4'
      ];

      for (let i = 0; i < 7; i++) {
        const cell = document.createElement('div');
        cell.className = 'slot-cell';
        cell.dataset.index = i;

        const label = document.createElement('div');
        label.className = 'slot-cell-label';
        label.textContent = labels[i];

        const icon = document.createElement('div');
        icon.className = 'slot-icon';
        icon.textContent = 'â€”';

        const name = document.createElement('div');
        name.className = 'slot-name';
        name.textContent = '';

        cell.appendChild(label);
        cell.appendChild(icon);
        cell.appendChild(name);
        slotBoardEl.appendChild(cell);
      }
    }

    function renderSlotBoard() {
      const cells = Array.from(slotBoardEl.querySelectorAll('.slot-cell'));

      // killer slot
      const killerCell = cells[0];
      const killerIcon = killerCell.querySelector('.slot-icon');
      const killerName = killerCell.querySelector('.slot-name');
      killerIcon.innerHTML = '';
      killerName.textContent = '';

      if (slotState.killerKey && KILLERS[slotState.killerKey]) {
        const killer = KILLERS[slotState.killerKey];
        const img = document.createElement('img');
        img.src = killer.img || '';
        img.alt = slotState.killerKey;
        img.title = killer.zh ? `${slotState.killerKey} / ${killer.zh}` : slotState.killerKey;
        killerIcon.appendChild(img);
        killerName.textContent = killer.zh ? `${killer.zh} / ${slotState.killerKey}` : slotState.killerKey;
      } else {
        killerIcon.textContent = 'â€”';
      }

      // addon slots (1,2)
      for (let i = 0; i < 2; i++) {
        const cell = cells[1 + i];
        const icon = cell.querySelector('.slot-icon');
        const nameEl = cell.querySelector('.slot-name');
        icon.innerHTML = '';
        nameEl.textContent = '';

        const addonName = slotState.addons[i];
        if (addonName && ADDONS[addonName]) {
          const addon = ADDONS[addonName];
          const img = document.createElement('img');
          img.src = addon.img || '';
          img.alt = addonName;
          const zh = addon.zh || '';
          img.title = zh ? `${addonName} / ${zh}` : addonName;
          icon.appendChild(img);
          nameEl.textContent = zh ? `${addonName} / ${zh}` : addonName;
        } else {
          icon.textContent = 'â€”';
        }
      }

      // perk slots (3,4,5,6)
      for (let i = 0; i < 4; i++) {
        const cell = cells[3 + i];
        const icon = cell.querySelector('.slot-icon');
        const nameEl = cell.querySelector('.slot-name');
        icon.innerHTML = '';
        nameEl.textContent = '';

        const perkName = slotState.perks[i];
        if (perkName && PERKS[perkName]) {
          const perk = PERKS[perkName];
          const img = document.createElement('img');
          img.src = perk.img || '';
          img.alt = perkName;
          const zh = perk.zh || '';
          img.title = zh ? `${perkName} / ${zh}` : perkName;
          icon.appendChild(img);
          nameEl.textContent = zh ? `${perkName} / ${zh}` : perkName;
        } else {
          icon.textContent = 'â€”';
        }
      }
    }

    function resetSlotState() {
      slotState.killerKey = null;
      slotState.addons = [];
      slotState.perks = [];
      slotState.locked = false;
      slotState.afterFull = false;

      if (slotState.animTimeout) {
        clearTimeout(slotState.animTimeout);
        slotState.animTimeout = null;
      }

      slotBoardEl.classList.remove('win-anim');
      if (slotOverlayEl) slotOverlayEl.classList.add('hidden');

      const machineEl = document.querySelector('.slot-machine');
      if (machineEl) {
        machineEl.classList.remove('glow');
      }

      slotBtn.disabled = false;
      slotBtn.textContent = 'ğŸ° æŠ½ä¸€æ ¼';

      renderSlotBoard();
    }

    function getRandomItem(arr) {
      if (!arr.length) return null;
      const idx = Math.floor(Math.random() * arr.length);
      return arr[idx];
    }

    function drawOneSlot() {
      if (slotState.locked || slotState.afterFull) return;

      const filledCount =
        (slotState.killerKey ? 1 : 0) +
        slotState.addons.length +
        slotState.perks.length;

      if (filledCount >= 7) return;

      const step = filledCount;

      if (step === 0) {
        const killerKeys = Object.keys(KILLERS || {});
        if (!killerKeys.length) return;
        slotState.killerKey = getRandomItem(killerKeys);

      } else if (step === 1 || step === 2) {
        const pool = Object.entries(ADDONS || {})
          .filter(([name, a]) =>
            a &&
            a.killer === slotState.killerKey &&
            !slotState.addons.includes(name)
          )
          .map(([name]) => name);

        if (!pool.length) return;
        const chosen = getRandomItem(pool);
        if (chosen) slotState.addons.push(chosen);

      } else {
        const used = new Set(slotState.perks);
        const pool = Object.entries(PERKS || {})
          .filter(([perkName, perk]) => {
            if (used.has(perkName)) return false;
            if (!perk || typeof perk !== 'object') return false;
            return true;
          })
          .map(([name]) => name);

        if (!pool.length) return;
        const chosen = getRandomItem(pool);
        if (chosen) slotState.perks.push(chosen);
      }


      renderSlotBoard();

      const newCount =
        (slotState.killerKey ? 1 : 0) +
        slotState.addons.length +
        slotState.perks.length;

      if (newCount >= 7) {
        slotState.locked = true;
        slotState.afterFull = true;

        if (window.CardSystem && typeof CardSystem.startCardPhase === 'function') {
          try {
            CardSystem.startCardPhase(slotState, {
              onApplied: (updatedState) => {
                if (updatedState) {
                  // å…ˆè¨˜éŒ„èˆŠç‹€æ…‹ï¼Œç”¨ä¾†åˆ¤æ–·å“ªäº›æ ¼å­æœ‰è®ŠåŒ–
                  const prevState = {
                    killerKey: slotState.killerKey,
                    addons: Array.isArray(slotState.addons) ? [...slotState.addons] : [],
                    perks: Array.isArray(slotState.perks) ? [...slotState.perks] : []
                  };

                  const changedIndices = [];

                  // æ®ºæ‰‹æ ¼ï¼šindex 0
                  if (typeof updatedState.killerKey !== 'undefined' &&
                    updatedState.killerKey !== prevState.killerKey) {
                    changedIndices.push(0);
                  }

                  // é…ä»¶æ ¼ï¼šindex 1,2
                  if (Array.isArray(updatedState.addons)) {
                    for (let i = 0; i < 2; i++) {
                      const beforeAddon = prevState.addons[i] || null;
                      const afterAddon = updatedState.addons[i] || null;
                      if (beforeAddon !== afterAddon) {
                        changedIndices.push(1 + i);
                      }
                    }
                  }

                  // æŠ€èƒ½æ ¼ï¼šindex 3,4,5,6
                  if (Array.isArray(updatedState.perks)) {
                    for (let i = 0; i < 4; i++) {
                      const beforePerk = prevState.perks[i] || null;
                      const afterPerk = updatedState.perks[i] || null;
                      if (beforePerk !== afterPerk) {
                        changedIndices.push(3 + i);
                      }
                    }
                  }

                  const uniqueChanged = [...new Set(changedIndices)];
                  const hasChanged = uniqueChanged.length > 0;

                  if (!hasChanged) {
                    // æ²’æ±è¥¿è®ŠåŒ–å°±æ­£å¸¸å¥—ç”¨
                    if (typeof updatedState.killerKey !== 'undefined') {
                      slotState.killerKey = updatedState.killerKey;
                    }
                    if (Array.isArray(updatedState.addons)) {
                      slotState.addons = [...updatedState.addons];
                    }
                    if (Array.isArray(updatedState.perks)) {
                      slotState.perks = [...updatedState.perks];
                    }
                    renderSlotBoard();
                  } else {
                    const cells = Array.from(slotBoardEl.querySelectorAll('.slot-cell'));
                    const DURATION = 300;

                    // å…ˆè®“èˆŠçš„åœ–ç¤ºå¾€ä¸Šæ·¡å‡º
                    uniqueChanged.forEach((idx) => {
                      const cell = cells[idx];
                      if (cell) {
                        cell.classList.add('slot-anim-out');
                      }
                    });

                    setTimeout(() => {
                      // å¥—ç”¨æ–°ç‹€æ…‹
                      if (typeof updatedState.killerKey !== 'undefined') {
                        slotState.killerKey = updatedState.killerKey;
                      }
                      if (Array.isArray(updatedState.addons)) {
                        slotState.addons = [...updatedState.addons];
                      }
                      if (Array.isArray(updatedState.perks)) {
                        slotState.perks = [...updatedState.perks];
                      }

                      // é‡ç•«æ•´å€‹ board
                      renderSlotBoard();

                      // è®“æ–°çš„åœ–ç¤ºç”±ä¸‹å¾€ä¸Šæ·¡å…¥
                      const freshCells = Array.from(slotBoardEl.querySelectorAll('.slot-cell'));
                      uniqueChanged.forEach((idx) => {
                        const cell = freshCells[idx];
                        if (cell) {
                          cell.classList.remove('slot-anim-out');
                          cell.classList.add('slot-anim-in');
                          setTimeout(() => {
                            cell.classList.remove('slot-anim-in');
                          }, DURATION);
                        }
                      });
                    }, DURATION);
                  }
                }
                slotState.locked = false;
              }
            });
          } catch (e) {
            console.error('CardSystem.startCardPhase ç™¼ç”ŸéŒ¯èª¤ï¼š', e);
            slotState.locked = false;
          }
        } else {
          slotState.locked = false;
        }
      }
    }

    // ==========================
    // äº‹ä»¶ç¶å®š & åˆå§‹åŒ–
    // ==========================
    // æ¨¡å¼åˆ‡æ›
    tabPoints.addEventListener('click', () => {
      if (currentMode === 'points') return;
      currentMode = 'points';
      tabPoints.classList.add('active');
      tabSlot.classList.remove('active');
      pointsModeEl.classList.remove('hidden');
      slotModeEl.classList.add('hidden');

      // åˆ‡åˆ°é…åˆ†æ¨¡å¼æ™‚ï¼Œéš±è—æ‹‰éœ¸å¡ç‰‡å€åŸŸï¼ˆä½†ä¸æ¸…é™¤å…§å®¹ï¼‰
      const cardContainer = document.getElementById('cardContainer');
      if (cardContainer) {
        cardContainer.classList.add('hidden');
      }
    });

    tabSlot.addEventListener('click', () => {
      if (currentMode === 'slot') return;
      currentMode = 'slot';
      tabSlot.classList.add('active');
      tabPoints.classList.remove('active');
      pointsModeEl.classList.add('hidden');
      slotModeEl.classList.remove('hidden');

      // åˆ‡å›æ‹‰éœ¸æ¨¡å¼ï¼Œå¦‚æœä¹‹å‰æœ‰å¡ç‰‡ï¼Œè®“å¡ç‰‡å®¹å™¨é‡æ–°é¡¯ç¤º
      const cardContainer = document.getElementById('cardContainer');
      if (cardContainer && cardContainer.children.length > 0) {
        cardContainer.classList.remove('hidden');
      }
    });


    // æ®ºæ‰‹æœå°‹
    killerSearchInput.addEventListener('input', () => {
      rebuildKillerOptions(killerSearchInput.value);
    });

    // æ®ºæ‰‹é¸æ“‡
    killerSelect.addEventListener('change', () => {
      currentKillerKey = killerSelect.value || null;
      selectedAddons = [];
      selectedPerks = [];
      renderKillerInfo();
      renderSelectedAddons();
      renderSelectedPerkIcons();
      updatePointsDisplay();
      renderAddonList();
      renderPerkList();
    });

    // é…ä»¶æœå°‹ / åˆ†æ•¸éæ¿¾
    addonSearchInput.addEventListener('input', renderAddonList);
    addonScoreFilter.addEventListener('change', renderAddonList);

    // æŠ€èƒ½æœå°‹ / åˆ†æ•¸éæ¿¾
    perkSearchInput.addEventListener('input', renderPerkList);
    perkScoreFilter.addEventListener('change', renderPerkList);

    // æ¸…ç©ºç›®å‰é…ç½®
    clearBuildBtn.addEventListener('click', () => {
      selectedAddons = [];
      selectedPerks = [];
      renderSelectedAddons();
      renderSelectedPerkIcons();
      updatePointsDisplay();
      renderAddonList();
      renderPerkList();
    });

    // æ‹‰éœ¸ï¼šæŠ½ä¸€æ ¼ï¼ˆéš±è—æŒ‰éˆ•ï¼‰
    slotBtn.addEventListener('click', () => {
      drawOneSlot();
    });

    // æ‹‰éœ¸ï¼šæ‰‹å‹•é‡ç½®
    slotResetBtn.addEventListener('click', () => {
      resetSlotState();
    });

    // æ‹‰æ¡¿æ§åˆ¶
    if (leverNormalEl && leverBottomEl) {
      leverNormalEl.addEventListener('mousedown', () => {
        if (slotState.locked) return;

        if (slotState.afterFull) {
          slotState.afterFull = false;
          leverNormalEl.style.display = 'none';
          leverBottomEl.style.display = 'flex';
          resetSlotState();
          return;
        }

        leverNormalEl.style.display = 'none';
        leverBottomEl.style.display = 'flex';
        drawOneSlot();
      });

      leverBottomEl.addEventListener('mouseup', () => {
        leverBottomEl.style.display = 'none';
        leverNormalEl.style.display = 'flex';
      });

      leverBottomEl.addEventListener('mouseleave', () => {
        leverBottomEl.style.display = 'none';
        leverNormalEl.style.display = 'flex';
      });
    }

    // åˆå§‹åŒ–
    initKillerData();
    renderKillerInfo();
    renderSelectedAddons();
    renderSelectedPerkIcons();
    updatePointsDisplay();
    renderAddonList();
    renderPerkList();
    initSlotBoard();
    renderSlotBoard();
  </script>



  <!-- å¹¸é‹ç¥ç±¤ï¼šæ”¾å¤§ç¥ç±¤è¦–çª— -->
  <div id="fortuneModal"
    style="position:fixed; inset:0; background:rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index:2000;">

    <div style="
      position:relative;
      width:400px;
      height:600px;
      background:url('./images/other/ç±¤.png') center/cover no-repeat;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:32px 24px;
      box-shadow:0 12px 32px rgba(0,0,0,0.6);
      border-radius:18px;
  ">

      <!-- æŠ€èƒ½åœ–ç¤º -->
      <img id="fortuneModalPerkIcon" src="" alt="å¹¸é‹æŠ€èƒ½"
        style="width:200px; height:200px; margin-top:7px; margin-bottom:8px;">

      <!-- æ¨™é¡Œ -->
      <div id="fortuneMainTitle" style="font-size:24px; font-weight:800; margin-bottom:2px; text-align:center;">
        æœ¬å ´å¹¸é‹æŠ€èƒ½
      </div>

      <!-- æŠ€èƒ½åç¨±ï¼ˆä¸­æ–‡ + è‹±æ–‡ï¼‰ -->
      <div id="fortuneSkillName"
        style="font-size:32px; font-weight:700; margin-bottom:2px; text-align:center; white-space:pre-line; line-height:1.2;">
      </div>

      <!-- ç±¤è©©ï¼ˆç›´æ›¸ï¼‰ -->
      <div id="fortunePoem" style="
    display:flex;
    flex-direction:row;
    justify-content:center;
    align-items:flex-start;
    gap:40px;
    width:100%;
    margin-top:8px;
">

      </div>



    </div>

  </div>

  <!-- é—œé–‰ç´ -->
  <button id="fortuneModalClose" type="button" style="position:absolute; right:16px; top:16px; border:none; background:rgba(0,0,0,0.55); color:#f5f5f5;
      border-radius:999px; padding:4px 10px; font-size:12px; cursor:pointer;">âœ•</button>

  </div>
  </div>


  <script>
    (function () {
      const tube = document.getElementById('fortuneTubeBtn');
      const resultIcon = document.getElementById('fortuneResultIcon');
      const resultImg = document.getElementById('fortuneResultPerkImg');
      const modal = document.getElementById('fortuneModal');
      const modalIcon = document.getElementById('fortuneModalPerkIcon');
      const modalName = document.getElementById('fortuneModalName');
      const modalDesc = document.getElementById('fortuneModalDesc');
      const modalClose = document.getElementById('fortuneModalClose');

      if (!tube) return;

      let currentFortune = null;

      function drawFortune() {
        const perks = window.PERKS || {};
        const keys = Object.keys(perks);
        if (!keys.length) return;

        const key = keys[Math.floor(Math.random() * keys.length)];
        const perk = perks[key];

        currentFortune = { key, perk };

        if (perk && perk.img) {
          resultImg.src = perk.img;
        } else {
          resultImg.src = '';
        }

        resultIcon.style.display = 'block';
      }

      function openModal() {
        if (!currentFortune) return;
        const { key, perk } = currentFortune;


        const zh = (perk && perk.zh) ? perk.zh : '';

        const fortune = (window.pickFortune && perk)
          ? window.pickFortune(perk)
          : '';

        if (perk && perk.img) {
          modalIcon.src = perk.img;
        } else {
          modalIcon.src = '';
        }

        document.getElementById("fortuneMainTitle").textContent = "æœ¬å ´å¹¸é‹æŠ€èƒ½";

        document.getElementById("fortuneSkillName").textContent = zh || 'æœªçŸ¥æŠ€èƒ½';


        // === æ­£ç¢ºåˆ‡æˆ 5 / 7 / 5 ã€Œå¥å­ã€è€Œä¸æ˜¯ slice å­— ===
        const parts = fortune.split("ã€€"); // å…¨å½¢ç©ºæ ¼åˆ‡å¥
        const p1 = parts[0] || "";
        const p2 = parts[1] || "";
        const p3 = parts[2] || "";

        function makePoemColumn(text) {
          return `
    <div style="
      writing-mode: vertical-rl;
      text-orientation: upright;
      font-size: 28px;
      line-height: 32px;
      width: 32px;
      text-align: center;
    ">
      ${text}
    </div>
  `;
        }

        document.getElementById("fortunePoem").innerHTML = `
  ${makePoemColumn(p1)}
  ${makePoemColumn(p2)}
  ${makePoemColumn(p3)}
`;



        modal.style.display = 'flex';
      }



      function closeModal() {
        modal.style.display = 'none';
      }

      tube.addEventListener('click', drawFortune);
      resultIcon.addEventListener('click', openModal);
      modalClose.addEventListener('click', closeModal);

      modal.addEventListener('click', function (e) {
        if (e.target === modal) {
          closeModal();
        }
      });
    })();
  </script>

  <!-- Fortune System Updated -->
  <script>
    // å’Œé¢¨ 5-7-5 å¹¸é‹ç¥ç±¤æ± 
    const FORTUNE_POOL = [
      "åœ°é“ç„¡æ‰€éã€€éœ§æ·±å½±éœå¿ƒè‡ªæ˜ã€€æ‰€å°‹çš†å¯è‡³",
      "æ°£è„ˆå¿½éœ‡å‹•ã€€æ”¾æ‰‹ä¹‹æ™‚é›·è²ç ´ã€€äº‚å‹¢äº¦æˆæ©Ÿ",
      "ç®±ä¸­ç„¡å½©é‹ã€€å‘½ç†æœ¬æ·¡æ£•å½±éš¨ã€€å¹³å‡¡äº¦æˆç¦",
      "è—å½¢å¦‚è‰è˜‘ã€€éœ§å‹•é¢¨æ¯å½±è‡ªé¡¯ã€€ç„¡è™•å¯è—èº«",
      "å¿ƒå‹¢å¦‚é‹’å®šã€€æ©Ÿå…ˆä¸€æ­¥æ™ºå‹æ•µã€€ç®—ç›¡çš†æˆä½ ",
      "æ«ƒå½±é›£è—æ°£ã€€é–€æ‰‰è¼•åˆèæ°£æ¯ã€€åŒ¿è¹¤è¦‹çœŸå½¢",
      "æ¿å½±å¿½ç”Ÿè®Šã€€æƒ¡éˆæš—æ‰‹ç‰½è¡Œè·¯ã€€æœ¨å¿ƒæ‡‰é¢¨æŠ˜",
      "æ€¨æ¯çºè¶³ä¸‹ã€€å¹½æ‰‹ç‰½å½±ç¸›å¥”å‹¢ã€€æ­¥ç·©å‘½é›£è„«",
      "å¿ƒéœå¦‚æ¹–é¢ã€€ä¸äº‚ä¸æ…Œæ­¥è‡ªç©©ã€€æ‰€è¡Œçš†é †é‚",
      "é‹’æ„è‡ªç›¸æ‡‰ã€€åˆ€è¿½äººå½±ç„¡ä¸€å·®ã€€æµå…‰ç ´æš—è¡Œ",
      "éºµç·šä¸ç³¾çµã€€éŒ¯ç¶œç¨‹å¼ä»Šå¤œç©©ã€€æ•…éšœä¸ä¾†æ“¾",
      "æ°£å’Œé¢¨è‡ªé †ã€€æ•µäº¦å®ˆåˆ†é¢¨æ¸…æœ—ã€€æˆ²å±€å°‘ä¹–å¼µ",
      "éµæ„æŸ“åˆƒç«¯ã€€æ±¡æ¿äº¦èƒ½æ–¬ç™¾éšªã€€æ‰€æŒ‡çš†å‘½ä¸­"
    ];

    // æœ‰æ¢ä»¶ç±¤æ–‡ï¼ˆå„å’’ / å¤©ç½ï¼‰
    const FORTUNE_CONDITION = {
      hex: "ç¬¦ç´‹è—å’’æ¯ã€€å„å’’æ·±éš±é›£è¦“è¹¤ã€€å‘½ç†è‡ªç›¸è­·",
      scourge: "é¢¨é³´å¼•æ¥­å½±ã€€å¤©ç½é‰¤ç¾å›å´ç•”ã€€é‹å‹¢ä»Šç…§èº«"
    };

    // ä¾ç…§æŠ€èƒ½æ±ºå®šè©©ç±¤
    window.pickFortune = function (perk) {
      const als = perk.aliases || [];
      const hasHex = als.some(a => /å„å’’|hex/i.test(a));
      const hasScourge = als.some(a => /å¤©ç½|scourge/i.test(a));

      if (hasHex) return FORTUNE_CONDITION.hex;
      if (hasScourge) return FORTUNE_CONDITION.scourge;

      return FORTUNE_POOL[Math.floor(Math.random() * FORTUNE_POOL.length)];
    };
  </script>

</body>

</html>